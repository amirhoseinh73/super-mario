var O=Object.defineProperty;var D=(s,e,t)=>e in s?O(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>(D(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const x=16;var T=(s=>(s[s.x=64]="x",s[s.y=64]="y",s))(T||{}),S=(s=>(s[s.w=14]="w",s[s.h=16]="h",s))(S||{}),w=(s=>(s[s.w=16]="w",s[s.h=16]="h",s))(w||{});const X=1500,K=1,$=0;var y=(s=>(s.SPACE="Space",s.ARROW_RIGHT="ArrowRight",s.ARROW_LEFT="ArrowLeft",s.SPEED_X="KeyX",s))(y||{});const z=256,C=256;var L=(s=>(s[s.width=64]="width",s[s.height=64]="height",s))(L||{});const M=.001,J=2e-4,h={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")};class V{constructor(){r(this,"keyStates");r(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(e,t){this.keyMap.set(e,t)}handleEvent(e){const{code:t}=e;if(!this.keyMap.has(t))return;e.preventDefault();const n=e.type==="keydown"?K:$;this.keyStates.get(t)!==n&&(this.keyStates.set(t,n),this.keyMap.get(t)(n))}listenTo(e){["keydown","keyup"].forEach(n=>{e.addEventListener(n,i=>{this.handleEvent(i)})})}}const A=function(s,e){e?s.jump.start():s.jump.cancel()},F=function(s,e){s.turbo&&s.turbo(e)},P=function(s,e){s.go.dir+=e?1:-1},q=function(s,e){s.go.dir+=e?-1:1},U=function(s,e){return function(n){const i=Math.floor(n/e)%s.length;return s[i]}},Q=function(s){const e=new V;return e.addMapping(y.SPACE,t=>{A(s,t)}),e.addMapping(y.SPEED_X,t=>{F(s,t)}),e.addMapping(y.ARROW_RIGHT,t=>{P(s,t)}),e.addMapping(y.ARROW_LEFT,t=>{q(s,t)}),e};class N{constructor(e=1/60){r(this,"update");r(this,"updateProxy");let t=0,n=0;this.updateProxy=i=>{for(t+=(i-n)/1e3,t>1&&(t=1);t>e;)this.update(e),t-=e;n=i,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class G{constructor(){r(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((t,n)=>{t.forEach((i,o)=>{e(i,n,o)})})}get(e,t){const n=this.grid[e];if(n)return n[t]}set(e,t,n){this.grid[e]||(this.grid[e]=[]),this.grid[e][t]=n}}class m{constructor(e,t){r(this,"x");r(this,"y");this.set(e,t)}set(e,t){this.x=e,this.y=t}}class Z{constructor(){r(this,"pos");r(this,"size");this.pos=new m(0,0),this.size=new m(z,C)}}class _{constructor(){r(this,"layers");this.layers=[]}draw(e,t){this.layers.forEach(n=>{n(e,t)})}}class I{constructor(e){r(this,"entities");this.entities=e}check(e){this.entities.forEach(t=>{e!==t&&e.bounds.overlaps(t.bounds)&&(e.collides(t),t.collides(e))})}}class R{constructor(e,t=x){r(this,"matrix");r(this,"tileSize");this.matrix=e,this.tileSize=t}toIndex(e){return Math.floor(e/this.tileSize)}toIndexRange(e,t){const n=Math.ceil(t/this.tileSize)*this.tileSize,i=[];let o=e;do i.push(this.toIndex(o)),o+=this.tileSize;while(o<n);return i}getByIndex(e,t){const n=this.matrix.get(e,t);if(n){const i=e*this.tileSize,o=i+this.tileSize,c=t*this.tileSize,a=c+this.tileSize;return{tile:n,x1:i,x2:o,y1:c,y2:a}}}searchByPosition(e,t){return this.getByIndex(this.toIndex(e),this.toIndex(t))}searchByRange(e,t,n,i){const o=[];return this.toIndexRange(e,t).forEach(c=>{this.toIndexRange(n,i).forEach(a=>{const l=this.getByIndex(c,a);l&&o.push(l)})}),o}}class Y{constructor(e){r(this,"tiles");this.tiles=new R(e)}checkX(e){let t;if(e.vel.x>0)t=e.bounds.right;else if(e.vel.x<0)t=e.bounds.left;else return;this.tiles.searchByRange(t,t,e.bounds.top,e.bounds.bottom).forEach(i=>{i.tile.type==="ground"&&(e.vel.x>0?e.bounds.right>i.x1&&(e.bounds.right=i.x1,e.vel.x=0,e.obstruct(h.RIGHT)):e.vel.x<0&&e.bounds.left<i.x2&&(e.bounds.left=i.x2,e.vel.x=0,e.obstruct(h.RIGHT)))})}checkY(e){let t;if(e.vel.y>0)t=e.bounds.bottom;else if(e.vel.y<0)t=e.bounds.top;else return;this.tiles.searchByRange(e.bounds.left,e.bounds.right,t,t).forEach(i=>{i.tile.type==="ground"&&(e.vel.y>0?e.bounds.bottom>i.y1&&(e.bounds.bottom=i.y1,e.vel.y=0,e.obstruct(h.BOTTOM)):e.vel.y<0&&e.bounds.top<i.y2&&(e.bounds.top=i.y2,e.vel.y=0,e.obstruct(h.TOP)))})}}class ee{constructor(){r(this,"gravity");r(this,"comp");r(this,"entities");r(this,"tiles");r(this,"tileCollider");r(this,"entityCollider");r(this,"totalTime");this.gravity=X,this.totalTime=0,this.comp=new _,this.entities=new Set,this.entityCollider=new I(this.entities),this.tileCollider=null}setCollisionGrid(e){this.tileCollider=new Y(e)}update(e){this.entities.forEach(t=>{this.tileCollider&&(t.update(e,this),t.pos.x+=t.vel.x*e,this.tileCollider.checkX(t),t.pos.y+=t.vel.y*e,this.tileCollider.checkY(t),t.vel.y+=this.gravity*e)}),this.entities.forEach(t=>{this.entityCollider.check(t)}),this.totalTime+=e}}const te=function(s,e,t){const n=new R(e),i=document.createElement("canvas");i.width=z,i.height=C;const o=i.getContext("2d");function c(a,l){o.clearRect(0,0,i.width,i.height);for(let d=a;d<=l;++d){const u=e.grid[d];u&&u.forEach((p,g)=>{const k=p;t.animations.has(k.name)?t.drawAnim(k.name,o,d-a,g,s.totalTime):t.drawTile(k.name,o,d-a,g)})}}return function(l,d){const u=n.toIndex(d.size.x),p=n.toIndex(d.pos.x),g=p+u;c(p,g),l.drawImage(i,-d.pos.x%x,-d.pos.y)}},se=function(s,e=L.width,t=L.width){const n=document.createElement("canvas");n.width=e,n.height=t;const i=n.getContext("2d");return function(c,a){s.forEach(l=>{i.clearRect(0,0,e,t),l.draw(i),c.drawImage(n,l.pos.x-a.pos.x,l.pos.y-a.pos.y)})}};function ie(s){var o;const e=[],t=(o=s.tileCollider)==null?void 0:o.tiles;if(!t)return;const n=t.tileSize,i=t.getByIndex;return t.getByIndex=function(a,l){return e.push({x:a,y:l}),i.call(t,a,l)},function(a,l){a.strokeStyle="blue",e.forEach(({x:d,y:u})=>{a.beginPath(),a.rect(d*n-l.pos.x,u*n-l.pos.y,n,n),a.stroke()}),a.strokeStyle="red",s.entities.forEach(d=>{a.beginPath(),a.rect(d.bounds.left-l.pos.x,d.bounds.top-l.pos.y,d.size.x,d.size.y),a.stroke()}),e.length=0}}class ne{constructor(e,t,n){r(this,"image");r(this,"width");r(this,"height");r(this,"tiles");r(this,"animations");this.image=e,this.width=t,this.height=n,this.tiles=new Map,this.animations=new Map}defineAnim(e,t){this.animations.set(e,t)}define(e,t,n,i,o){const c=[!1,!0].map(a=>{const l=document.createElement("canvas");l.width=i,l.height=o;const d=l.getContext("2d");return a&&(d.scale(-1,1),d.translate(-i,0)),d.drawImage(this.image,t,n,i,o,0,0,i,o),l});this.tiles.set(e,c)}defineTile(e,t,n){this.define(e,t*this.width,n*this.height,this.width,this.height)}draw(e,t,n,i,o=!1){const c=this.tiles.get(e);c&&t.drawImage(c[Number(o)],n,i)}drawAnim(e,t,n,i,o){const c=this.animations.get(e);this.drawTile(c(o),t,n,i)}drawTile(e,t,n,i){this.draw(e,t,n*this.width,i*this.height)}}class oe{constructor(e,t,n){r(this,"pos");r(this,"size");r(this,"offset");this.pos=e,this.size=t,this.offset=n}overlaps(e){return this.bottom>e.top&&this.top<e.bottom&&this.left<e.right&&this.right>e.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(e){this.pos.y=e-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(e){this.pos.y=e-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(e){this.pos.x=e-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(e){this.pos.x=e-(this.size.x+this.offset.x)}}class f{constructor(e){r(this,"NAME");this.NAME=e}collides(e,t){}obstruct(e,t){}update(e,t,n=void 0){}}class b{constructor(){r(this,"pos");r(this,"vel");r(this,"size");r(this,"offset");r(this,"bounds");r(this,"traits");r(this,"lifetime");r(this,"turbo");this.pos=new m(0,0),this.vel=new m(0,0),this.size=new m(0,0),this.offset=new m(0,0),this.bounds=new oe(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[]}addTrait(e){this.traits.push(e),this[e.NAME]=e}collides(e){this.traits.forEach(t=>{t.collides(this,e)})}obstruct(e){this.traits.forEach(t=>{t.obstruct(this,e)})}update(e,t){this.traits.forEach(n=>{n.update(this,e,t)}),this.lifetime+=e}draw(e){}}class B extends f{constructor(){super("killable");r(this,"dead");r(this,"deadTime");r(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.dead=!0}revive(){this.dead=!1,this.deadTime=0}update(t,n,i){this.dead&&(this.deadTime+=n,!(this.deadTime<=this.removeAfter)&&i.entities.delete(t))}}class W extends f{constructor(){super("pendulumWalk");r(this,"speed");this.speed=-30}obstruct(t,n){(n===h.LEFT||n===h.RIGHT)&&(this.speed=-this.speed)}update(t,n){t.vel.x=this.speed}}const re=async function(){return v("goomba").then(ce)};let ae=class extends f{constructor(){super("behavior")}collides(e,t){if(!e.killable.dead&&t.stomper){if(t.vel.y<=e.vel.y){t.killable.kill();return}t.stomper.bounce(),e.killable.kill(),e.pendulumWalk.speed=0}}};const ce=function(s){const e=s.animations.get("walk"),t=function(i){return i.killable.dead?"flat":e(i.lifetime)},n=function(i){s.draw(t(this),i,0,0)};return function(){const o=new b;return o.size.set(w.w,w.h),o.addTrait(new W),o.addTrait(new ae),o.addTrait(new B),o.draw=n,o}},le=async function(){return v("koopa").then(ue)};class de extends f{constructor(){super("behavior")}collides(e,t){if(!e.killable.dead&&t.stomper){if(t.vel.y<=e.vel.y){t.killable.kill();return}t.stomper.bounce(),e.killable.kill(),e.pendulumWalk.speed=0}}}const ue=function(s){const e=s.animations.get("walk"),t=function(i){return i.killable.dead?"hiding":e(i.lifetime)},n=function(i){s.draw(t(this),i,0,0,this.vel.x<0)};return function(){const o=new b;return o.size.set(w.w,w.h),o.offset.y=8,o.addTrait(new W),o.addTrait(new de),o.addTrait(new B),o.draw=n,o}};class he extends f{constructor(){super("go");r(this,"dir");r(this,"acceleration");r(this,"deceleration");r(this,"dragFactor");r(this,"distance");r(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=M,this.distance=0,this.heading=1}update(t,n){const i=Math.abs(t.vel.x);if(this.dir!==0)t.vel.x+=this.acceleration*n*this.dir,t.jump?t.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(t.vel.x!==0){const c=Math.min(i,this.deceleration*n);t.vel.x+=t.vel.x>0?-c:c}else this.distance=0;const o=this.dragFactor*t.vel.x*i;t.vel.x-=o,this.distance+=i*n}}class fe extends f{constructor(){super("jump");r(this,"duration");r(this,"velocity");r(this,"engageTime");r(this,"ready");r(this,"requestTime");r(this,"gracePeriod");r(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(t,n){n===h.BOTTOM?this.ready=1:n===h.TOP&&this.cancel()}update(t,n){this.requestTime>0&&(this.ready>0&&(this.engageTime=this.duration,this.requestTime=0),this.requestTime-=n),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),this.engageTime-=n),this.ready--}}class pe extends f{constructor(){super("stomper");r(this,"queueBounce");r(this,"bounceSpeed");this.bounceSpeed=400,this.queueBounce=!1}bounce(){this.queueBounce=!0}update(t,n){this.queueBounce&&(t.vel.y=-this.bounceSpeed,this.queueBounce=!1)}}const me=async function(){return v("mario").then(ge)},ge=function(s){const e=s.animations.get("run");function t(o){return o.jump.falling?"jump":o.go.distance>0?o.vel.x>0&&o.go.dir<0||o.vel.x<0&&o.go.dir>0?"break":e(o.go.distance):"idle"}function n(o){this.go.dragFactor=o?J:M}function i(o){s.draw(t(this),o,0,0,this.go.heading<0)}return function(){const c=new b;return c.size.set(S.w,S.h),c.addTrait(new he),c.addTrait(new fe),c.addTrait(new pe),c.addTrait(new B),c.killable.removeAfter=0,c.turbo=n,c.draw=i,c.turbo(!1),c}},ye=function(s){return new Promise(e=>{const t=new Image;t.addEventListener("load",()=>{e(t)}),t.src=s})},j=async function(s){return fetch(s).then(e=>e.json())},v=async function(s){var i,o,c;const e=await j(`/@sprites/${s}.json`),t=await ye(e.imageURL),n=new ne(t,e.tileW||x,e.tileH||x);return(i=e.tiles)==null||i.forEach(a=>{n.defineTile(a.name,a.index[0],a.index[1])}),(o=e.frames)==null||o.forEach(a=>{n.define(a.name,...a.rect)}),(c=e.animations)==null||c.forEach(a=>{const l=U(a.frames,a.frameLen);n.defineAnim(a.name,l)}),n},we=function(){const s={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")}},e=function(t){return n=>s[t]=n};return Promise.all([me().then(e("mario")),re().then(e("goomba")),le().then(e("koopa"))]).then(()=>s)},E=function*(s,e,t,n){const i=s+e,o=t+n;for(let c=s;c<i;++c)for(let a=t;a<o;++a)yield{x:c,y:a}},xe=function(s){if(s.length===4){const[e,t,n,i]=s;return E(e,t,n,i)}else if(s.length===3){const[e,t,n]=s;return E(e,t,n,1)}else{const[e,t]=s;return E(e,1,t,1)}},be=function*(s){for(const e of s)yield*xe(e)},H=function*(s,e){function*t(n,i,o){for(const c of n)for(const{x:a,y:l}of be(c.ranges)){const d=a+i,u=l+o;if(c.pattern){const p=e[c.pattern];yield*t(p.tiles,d,u);continue}yield{tile:c,x:d,y:u}}}yield*t(s,0,0)},ve=function(s,e){const t=new G;for(const{tile:n,x:i,y:o}of H(s,e))t.set(i,o,{type:n.type});return t},ke=function(s,e){const t=new G;for(const{tile:n,x:i,y:o}of H(s,e))t.set(i,o,{name:n.name});return t},Ee=function(s,e){const t=s.layers.reduce((i,o)=>i.concat(o.tiles),[]),n=ve(t,s.patterns);e.setCollisionGrid(n)},Te=function(s,e,t){s.layers.forEach(n=>{const i=ke(n.tiles,s.patterns),o=te(e,i,t);e.comp.layers.push(o)})},Se=function(s,e,t){s.entities.forEach(({name:i,pos:[o,c]})=>{const a=t[i],l=a();l.pos.set(o,c),e.entities.add(l)});const n=se(e.entities);e.comp.layers.push(n)},Le=async function(s){return async function(t){const n=await j(`/@levels/${t}.json`),i=await v(n.spritesheet),o=new ee;return Ee(n,o),Te(n,o,i),Se(n,o,s),o}},Be=function(s){const e=document.querySelector("[data-action='left']"),t=document.querySelector("[data-action='right']"),n=document.querySelector("[data-action='jump']"),i=document.querySelector("[data-action='speed']"),o={left:{elem:e,fn:function(a){q(s,a)},handle:!1},right:{elem:t,fn:function(a){P(s,a)},handle:!1},jump:{elem:n,fn:function(a){A(s,a)},handle:!1},speed:{elem:i,fn:function(a){F(s,a)},handle:!1}};["pointerdown","pointerup","pointercancel","pointerout","pointerleave"].forEach(a=>{for(const l in o){const d=o[l];d.elem.addEventListener(a,function(){if(a==="pointerdown")return d.handle=!0,d.fn(!0);d.handle&&(d.fn(!1),d.handle=!1)})}})};class ze extends f{constructor(){super("playerController");r(this,"player");r(this,"checkpoint");this.checkpoint=new m(0,0),this.player=null}setPlayer(t){this.player=t}update(t,n,i){var o;this.player&&(i.entities.has(this.player)||((o=this.player.killable)==null||o.revive(),this.player.pos.set(this.checkpoint.x,this.checkpoint.y),i.entities.add(this.player)))}}const Ce=function(s){const e=new b,t=new ze;return t.checkpoint.set(T.x,T.y),t.setPlayer(s),e.addTrait(t),e},Me=async function(s){const e=s.getContext("2d"),t=await we(),i=await(await Le(t))("1-1"),o=new Z,c=t.mario(),a=Ce(c);i.entities.add(a);const l=ie(i);l&&i.comp.layers.push(l),Q(c).listenTo(window),Be(c);const u=new N;u.update=function(g){i.update(g),o.pos.x=Math.max(0,c.pos.x-100),i.comp.draw(e,o)},u.start()},Ae=document.getElementById("screen");Me(Ae);
