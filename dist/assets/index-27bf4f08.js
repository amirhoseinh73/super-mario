var O=Object.defineProperty;var D=(s,t,e)=>t in s?O(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>(D(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const v=16;var y=(s=>(s[s.x=64]="x",s[s.y=64]="y",s))(y||{}),S=(s=>(s[s.w=14]="w",s[s.h=16]="h",s))(S||{}),w=(s=>(s[s.w=16]="w",s[s.h=16]="h",s))(w||{});const X=1500,K=1,J=0;var g=(s=>(s.SPACE="Space",s.ARROW_RIGHT="ArrowRight",s.ARROW_LEFT="ArrowLeft",s.SPEED_X="KeyX",s))(g||{});const M=256,z=256;var L=(s=>(s[s.width=64]="width",s[s.height=64]="height",s))(L||{});const B=.001,V=2e-4,f={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")};class ${constructor(){r(this,"keyStates");r(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return;t.preventDefault();const n=t.type==="keydown"?K:J;this.keyStates.get(e)!==n&&(this.keyStates.set(e,n),this.keyMap.get(e)(n))}listenTo(t){["keydown","keyup"].forEach(n=>{t.addEventListener(n,i=>{this.handleEvent(i)})})}}const C=function(s,t){t?s.jump.start():s.jump.cancel()},A=function(s,t){s.turbo&&s.turbo(t)},F=function(s,t){s.go.dir+=t?1:-1},q=function(s,t){s.go.dir+=t?-1:1},U=function(s,t){return function(n){const i=Math.floor(n/t)%s.length;return s[i]}},Q=function(s){const t=new $;return t.addMapping(g.SPACE,e=>{C(s,e)}),t.addMapping(g.SPEED_X,e=>{A(s,e)}),t.addMapping(g.ARROW_RIGHT,e=>{F(s,e)}),t.addMapping(g.ARROW_LEFT,e=>{q(s,e)}),t};class N{constructor(t=1/60){r(this,"update");r(this,"updateProxy");let e=0,n=0;this.updateProxy=i=>{for(e+=(i-n)/1e3,e>1&&(e=1);e>t;)this.update(t),e-=t;n=i,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class G{constructor(){r(this,"grid");this.grid=[]}forEach(t){this.grid.forEach((e,n)=>{e.forEach((i,o)=>{t(i,n,o)})})}get(t,e){const n=this.grid[t];if(n)return n[e]}set(t,e,n){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=n}}class m{constructor(t,e){r(this,"x");r(this,"y");this.set(t,e)}set(t,e){this.x=t,this.y=e}}class Z{constructor(){r(this,"pos");r(this,"size");this.pos=new m(0,0),this.size=new m(M,z)}}class _{constructor(){r(this,"layers");this.layers=[]}draw(t,e){this.layers.forEach(n=>{n(t,e)})}}class Y{constructor(t){r(this,"entities");this.entities=t}check(t){this.entities.forEach(e=>{t!==e&&t.bounds.overlaps(e.bounds)&&(t.collides(e),e.collides(t))})}}class P{constructor(t,e=v){r(this,"matrix");r(this,"tileSize");this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const n=Math.ceil(e/this.tileSize)*this.tileSize,i=[];let o=t;do i.push(this.toIndex(o)),o+=this.tileSize;while(o<n);return i}getByIndex(t,e){const n=this.matrix.get(t,e);if(n){const i=t*this.tileSize,o=i+this.tileSize,a=e*this.tileSize,c=a+this.tileSize;return{tile:n,x1:i,x2:o,y1:a,y2:c}}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,n,i){const o=[];return this.toIndexRange(t,e).forEach(a=>{this.toIndexRange(n,i).forEach(c=>{const d=this.getByIndex(a,c);d&&o.push(d)})}),o}}class I{constructor(t){r(this,"tiles");this.tiles=new P(t)}checkX(t){let e;if(t.vel.x>0)e=t.bounds.right;else if(t.vel.x<0)e=t.bounds.left;else return;this.tiles.searchByRange(e,e,t.bounds.top,t.bounds.bottom).forEach(i=>{i.tile.type==="ground"&&(t.vel.x>0?t.bounds.right>i.x1&&(t.bounds.right=i.x1,t.vel.x=0,t.obstruct(f.RIGHT)):t.vel.x<0&&t.bounds.left<i.x2&&(t.bounds.left=i.x2,t.vel.x=0,t.obstruct(f.RIGHT)))})}checkY(t){let e;if(t.vel.y>0)e=t.bounds.bottom;else if(t.vel.y<0)e=t.bounds.top;else return;this.tiles.searchByRange(t.bounds.left,t.bounds.right,e,e).forEach(i=>{i.tile.type==="ground"&&(t.vel.y>0?t.bounds.bottom>i.y1&&(t.bounds.bottom=i.y1,t.vel.y=0,t.obstruct(f.BOTTOM)):t.vel.y<0&&t.bounds.top<i.y2&&(t.bounds.top=i.y2,t.vel.y=0,t.obstruct(f.TOP)))})}}class tt{constructor(){r(this,"gravity");r(this,"comp");r(this,"entities");r(this,"tiles");r(this,"tileCollider");r(this,"entityCollider");r(this,"totalTime");this.gravity=X,this.totalTime=0,this.comp=new _,this.entities=new Set,this.entityCollider=new Y(this.entities),this.tileCollider=null}setCollisionGrid(t){this.tileCollider=new I(t)}update(t){this.entities.forEach(e=>{this.tileCollider&&(e.update(t,this),e.pos.x+=e.vel.x*t,this.tileCollider.checkX(e),e.pos.y+=e.vel.y*t,this.tileCollider.checkY(e),e.vel.y+=this.gravity*t)}),this.entities.forEach(e=>{this.entityCollider.check(e)}),this.totalTime+=t}}const et=function(s,t,e){const n=new P(t),i=document.createElement("canvas");i.width=M,i.height=z;const o=i.getContext("2d");function a(c,d){o.clearRect(0,0,i.width,i.height);for(let l=c;l<=d;++l){const u=t.grid[l];u&&u.forEach((h,x)=>{const k=h;e.animations.has(k.name)?e.drawAnim(k.name,o,l-c,x,s.totalTime):e.drawTile(k.name,o,l-c,x)})}}return function(d,l){const u=n.toIndex(l.size.x),h=n.toIndex(l.pos.x),x=h+u;a(h,x),d.drawImage(i,-l.pos.x%v,-l.pos.y)}},st=function(s,t=L.width,e=L.width){const n=document.createElement("canvas");n.width=t,n.height=e;const i=n.getContext("2d");return function(a,c){s.forEach(d=>{i.clearRect(0,0,t,e),d.draw(i),a.drawImage(n,d.pos.x-c.pos.x,d.pos.y-c.pos.y)})}};class it{constructor(t,e,n){r(this,"image");r(this,"width");r(this,"height");r(this,"tiles");r(this,"animations");this.image=t,this.width=e,this.height=n,this.tiles=new Map,this.animations=new Map}defineAnim(t,e){this.animations.set(t,e)}define(t,e,n,i,o){const a=[!1,!0].map(c=>{const d=document.createElement("canvas");d.width=i,d.height=o;const l=d.getContext("2d");return c&&(l.scale(-1,1),l.translate(-i,0)),l.drawImage(this.image,e,n,i,o,0,0,i,o),d});this.tiles.set(t,a)}defineTile(t,e,n){this.define(t,e*this.width,n*this.height,this.width,this.height)}draw(t,e,n,i,o=!1){const a=this.tiles.get(t);a&&e.drawImage(a[Number(o)],n,i)}drawAnim(t,e,n,i,o){const a=this.animations.get(t);this.drawTile(a(o),e,n,i)}drawTile(t,e,n,i){this.draw(t,e,n*this.width,i*this.height)}}class nt{constructor(t,e,n){r(this,"pos");r(this,"size");r(this,"offset");this.pos=t,this.size=e,this.offset=n}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}class p{constructor(t){r(this,"NAME");this.NAME=t}collides(t,e){}obstruct(t,e){}update(t,e,n=void 0){}}class b{constructor(){r(this,"pos");r(this,"vel");r(this,"size");r(this,"offset");r(this,"bounds");r(this,"traits");r(this,"lifetime");r(this,"turbo");this.pos=new m(0,0),this.vel=new m(0,0),this.size=new m(0,0),this.offset=new m(0,0),this.bounds=new nt(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[]}addTrait(t){this.traits.push(t),this[t.NAME]=t}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}obstruct(t){this.traits.forEach(e=>{e.obstruct(this,t)})}update(t,e){this.traits.forEach(n=>{n.update(this,t,e)}),this.lifetime+=t}draw(t){}}class R extends p{constructor(){super("killable");r(this,"dead");r(this,"deadTime");r(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.dead=!0}revive(){this.dead=!1,this.deadTime=0}update(e,n,i){this.dead&&(this.deadTime+=n,!(this.deadTime<=this.removeAfter)&&i.entities.delete(e))}}class j extends p{constructor(){super("pendulumWalk");r(this,"speed");this.speed=-30}obstruct(e,n){(n===f.LEFT||n===f.RIGHT)&&(this.speed=-this.speed)}update(e,n){e.vel.x=this.speed}}const ot=async function(){return E("goomba").then(at)};class rt extends p{constructor(){super("behavior")}collides(t,e){if(!t.killable.dead&&e.stomper){if(e.vel.y<=t.vel.y){e.killable.kill();return}e.stomper.bounce(),t.killable.kill(),t.pendulumWalk.speed=0}}}const at=function(s){const t=s.animations.get("walk"),e=function(i){return i.killable.dead?"flat":t(i.lifetime)},n=function(i){s.draw(e(this),i,0,0)};return function(){const o=new b;return o.size.set(w.w,w.h),o.addTrait(new j),o.addTrait(new rt),o.addTrait(new R),o.draw=n,o}},ct=async function(){return E("koopa").then(lt)},lt=function(s){const t=s.animations.get("walk"),e=function(n){s.draw(t(this.lifetime),n,0,0,this.vel.x<0)};return function(){const i=new b;return i.size.set(w.w,w.h),i.offset.y=8,i.addTrait(new j),i.draw=e,i}};class dt extends p{constructor(){super("go");r(this,"dir");r(this,"acceleration");r(this,"deceleration");r(this,"dragFactor");r(this,"distance");r(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=B,this.distance=0,this.heading=1}update(e,n){const i=Math.abs(e.vel.x);if(this.dir!==0)e.vel.x+=this.acceleration*n*this.dir,e.jump?e.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(e.vel.x!==0){const a=Math.min(i,this.deceleration*n);e.vel.x+=e.vel.x>0?-a:a}else this.distance=0;const o=this.dragFactor*e.vel.x*i;e.vel.x-=o,this.distance+=i*n}}class ut extends p{constructor(){super("jump");r(this,"duration");r(this,"velocity");r(this,"engageTime");r(this,"ready");r(this,"requestTime");r(this,"gracePeriod");r(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(e,n){n===f.BOTTOM?this.ready=1:n===f.TOP&&this.cancel()}update(e,n){this.requestTime>0&&(this.ready>0&&(this.engageTime=this.duration,this.requestTime=0),this.requestTime-=n),this.engageTime>0&&(e.vel.y=-(this.velocity+Math.abs(e.vel.x)*this.speedBoost),this.engageTime-=n),this.ready--}}class ht extends p{constructor(){super("stomper");r(this,"queueBounce");r(this,"bounceSpeed");this.bounceSpeed=400,this.queueBounce=!1}bounce(){this.queueBounce=!0}update(e,n){this.queueBounce&&(e.vel.y=-this.bounceSpeed,this.queueBounce=!1)}}const ft=async function(){return E("mario").then(pt)},pt=function(s){const t=s.animations.get("run");function e(o){return o.jump.falling?"jump":o.go.distance>0?o.vel.x>0&&o.go.dir<0||o.vel.x<0&&o.go.dir>0?"break":t(o.go.distance):"idle"}function n(o){this.go.dragFactor=o?V:B}function i(o){s.draw(e(this),o,0,0,this.go.heading<0)}return function(){const a=new b;return a.size.set(S.w,S.h),a.addTrait(new dt),a.addTrait(new ut),a.addTrait(new ht),a.addTrait(new R),a.killable.removeAfter=0,a.turbo=n,a.draw=i,a.turbo(!1),a}},mt=function(s){return new Promise(t=>{const e=new Image;e.addEventListener("load",()=>{t(e)}),e.src=s})},W=async function(s){return fetch(s).then(t=>t.json())},E=async function(s){var i,o,a;const t=await W(`/@sprites/${s}.json`),e=await mt(t.imageURL),n=new it(e,t.tileW||v,t.tileH||v);return(i=t.tiles)==null||i.forEach(c=>{n.defineTile(c.name,c.index[0],c.index[1])}),(o=t.frames)==null||o.forEach(c=>{n.define(c.name,...c.rect)}),(a=t.animations)==null||a.forEach(c=>{const d=U(c.frames,c.frameLen);n.defineAnim(c.name,d)}),n},gt=function(){const s={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")}},t=function(e){return n=>s[e]=n};return Promise.all([ft().then(t("mario")),ot().then(t("goomba")),ct().then(t("koopa"))]).then(()=>s)},T=function*(s,t,e,n){const i=s+t,o=e+n;for(let a=s;a<i;++a)for(let c=e;c<o;++c)yield{x:a,y:c}},yt=function(s){if(s.length===4){const[t,e,n,i]=s;return T(t,e,n,i)}else if(s.length===3){const[t,e,n]=s;return T(t,e,n,1)}else{const[t,e]=s;return T(t,1,e,1)}},wt=function*(s){for(const t of s)yield*yt(t)},H=function*(s,t){function*e(n,i,o){for(const a of n)for(const{x:c,y:d}of wt(a.ranges)){const l=c+i,u=d+o;if(a.pattern){const h=t[a.pattern];yield*e(h.tiles,l,u);continue}yield{tile:a,x:l,y:u}}}yield*e(s,0,0)},xt=function(s,t){const e=new G;for(const{tile:n,x:i,y:o}of H(s,t))e.set(i,o,{type:n.type});return e},vt=function(s,t){const e=new G;for(const{tile:n,x:i,y:o}of H(s,t))e.set(i,o,{name:n.name});return e},bt=function(s,t){const e=s.layers.reduce((i,o)=>i.concat(o.tiles),[]),n=xt(e,s.patterns);t.setCollisionGrid(n)},Et=function(s,t,e){s.layers.forEach(n=>{const i=vt(n.tiles,s.patterns),o=et(t,i,e);t.comp.layers.push(o)})},kt=function(s,t,e){s.entities.forEach(({name:i,pos:[o,a]})=>{const c=e[i],d=c();d.pos.set(o,a),t.entities.add(d)});const n=st(t.entities);t.comp.layers.push(n)},Tt=async function(s){return async function(e){const n=await W(`/@levels/${e}.json`),i=await E(n.spritesheet),o=new tt;return bt(n,o),Et(n,o,i),kt(n,o,s),o}},St=function(s){const t=document.querySelector("[data-action='left']"),e=document.querySelector("[data-action='right']"),n=document.querySelector("[data-action='jump']"),i=document.querySelector("[data-action='speed']"),o={left:{elem:t,fn:function(c){q(s,c)},handle:!1},right:{elem:e,fn:function(c){F(s,c)},handle:!1},jump:{elem:n,fn:function(c){C(s,c)},handle:!1},speed:{elem:i,fn:function(c){A(s,c)},handle:!1}};["pointerdown","pointerup","pointercancel","pointerout","pointerleave"].forEach(c=>{for(const d in o){const l=o[d];l.elem.addEventListener(c,function(){if(c==="pointerdown")return l.handle=!0,l.fn(!0);l.handle&&(l.fn(!1),l.handle=!1)})}})};class Lt extends p{constructor(){super("playerController");r(this,"player");this.player=null}setPlayer(e){this.player=e}update(e,n,i){var o;this.player&&(i.entities.has(this.player)||((o=this.player.killable)==null||o.revive(),this.player.pos.set(y.x,y.y),i.entities.add(this.player)))}}const Mt=function(s){const t=new b,e=new Lt;return e.setPlayer(s),t.addTrait(e),t},zt=async function(s){const t=s.getContext("2d"),e=await gt(),i=await(await Tt(e))("1-1"),o=new Z,a=e.mario();a.pos.set(y.x,y.y),i.entities.add(a);const c=Mt(a);i.entities.add(c),Q(a).listenTo(window),St(a);const l=new N;l.update=function(h){i.update(h),o.pos.x=Math.max(0,a.pos.x-100),i.comp.draw(t,o)},l.start()},Bt=document.getElementById("screen");zt(Bt);
