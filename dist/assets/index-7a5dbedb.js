var bt=Object.defineProperty;var xt=(i,t,e)=>t in i?bt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>(xt(i,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();class tt{constructor(){a(this,"receivers");this.receivers=new Set}addReceiver(t){this.receivers.add(t)}dropReceiver(t){this.receivers.delete(t)}route(t){for(const e of this.receivers)t(e)}}const O=16,y=8;var v=(i=>(i[i.x=64]="x",i[i.y=64]="y",i))(v||{}),$=(i=>(i[i.w=14]="w",i[i.h=16]="h",i))($||{}),k=(i=>(i[i.w=16]="w",i[i.h=16]="h",i))(k||{}),K=(i=>(i[i.w=16]="w",i[i.h=14]="h",i))(K||{}),M=(i=>(i[i.x=100]="x",i[i.y=-200]="y",i))(M||{});const Et=1500,St=1,kt=0;var E=(i=>(i.SPACE="Space",i.ARROW_RIGHT="ArrowRight",i.ARROW_LEFT="ArrowLeft",i.SPEED_X="KeyX",i))(E||{});const et=256,st=256;var C=(i=>(i[i.width=64]="width",i[i.height=64]="height",i))(C||{});const it=.001,Mt=2e-4,f={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")},Ct=100,Rt=20,Lt="./assets/img/font-coin.png",At=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Y=30,U=100;class Pt{constructor(){a(this,"keyStates");a(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return;t.preventDefault();const s=t.type==="keydown"?St:kt;this.keyStates.get(e)!==s&&(this.keyStates.set(e,s),this.keyMap.get(e)(s))}listenTo(t){["keydown","keyup"].forEach(s=>{t.addEventListener(s,n=>{this.handleEvent(n)})})}}const nt=function(i,t){i?t.route(e=>e.jump.start()):t.route(e=>e.jump.cancel())},ot=function(i,t){t.route(e=>e.turbo&&e.turbo(i))},rt=function(i,t){t.route(e=>e.go.dir+=i?1:-1)},at=function(i,t){t.route(e=>e.go.dir+=i?-1:1)},Bt=function(i,t){return function(s){const n=Math.floor(s/t)%i.length;return i[n]}},zt=function(i){const t=new Pt,e=new tt;return t.listenTo(i),t.addMapping(E.SPACE,s=>{nt(s,e)}),t.addMapping(E.SPEED_X,s=>{ot(s,e)}),t.addMapping(E.ARROW_RIGHT,s=>{rt(s,e)}),t.addMapping(E.ARROW_LEFT,s=>{at(s,e)}),e};class Ft{constructor(t=1/60){a(this,"update");a(this,"updateProxy");let e=0,s=null;this.updateProxy=n=>{if(s)for(e+=(n-s)/1e3,e>1&&(e=1);e>t;)this.update(t),e-=t;s=n,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class Ot{constructor(){a(this,"grid");this.grid=[]}forEach(t){this.grid.forEach((e,s)=>{e.forEach((n,r)=>{t(n,s,r)})})}delete(t,e){const s=this.grid[t];s&&delete s[e]}get(t,e){const s=this.grid[t];if(s)return s[e]}set(t,e,s){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=s}}class T{constructor(t,e){a(this,"x");a(this,"y");this.set(t,e)}copy(t){this.x=t.x,this.y=t.y}set(t,e){this.x=t,this.y=e}}class ct{constructor(){a(this,"pos");a(this,"size");this.pos=new T(0,0),this.size=new T(et,st)}}class Nt{constructor(t){a(this,"entities");this.entities=t}check(t){this.entities.forEach(e=>{t!==e&&t.bounds.overlaps(e.bounds)&&t.collides(e)})}}class Dt{constructor(){a(this,"player");this.player=null}setPlayer(t){this.player=t}playTheme(t=1){var s;const e=(s=this.player)==null?void 0:s.playTrack("main");e.playbackRate=t}playHurryTheme(){var e;const t=(e=this.player)==null?void 0:e.playTrack("hurry");t.loop=!1,t.addEventListener("ended",()=>{this.playTheme(1.5)},{once:!0})}pause(){var t;(t=this.player)==null||t.pauseAll()}}class Gt{constructor(){a(this,"layers");this.layers=[]}draw(t,e){this.layers.forEach(s=>{s(t,e)})}}class _t{constructor(){a(this,"listeners");this.listeners=[]}listen(t,e){const s={name:t,callback:e};this.listeners.push(s)}emit(t,...e){this.listeners.forEach(s=>{s.name===t&&s.callback(...e)})}}class R{constructor(){a(this,"events");a(this,"comp");this.events=new _t,this.comp=new Gt}draw({videoContext:t}){this.comp.draw(t,new ct)}update(t){}pause(){console.log("Pause",this)}}a(R,"EVENT_COMPLETE",Symbol("scene complete"));class dt{constructor(t,e=O){a(this,"matrix");a(this,"tileSize");this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const s=Math.ceil(e/this.tileSize)*this.tileSize,n=[];let r=t;do n.push(this.toIndex(r)),r+=this.tileSize;while(r<s);return n}getByIndex(t,e){const s=this.matrix.get(t,e);if(!s)return;const n=t*this.tileSize,r=n+this.tileSize,o=e*this.tileSize,c=o+this.tileSize;return{tile:s,indexX:t,indexY:e,x1:n,x2:r,y1:o,y2:c}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,s,n){const r=[];return this.toIndexRange(t,e).forEach(o=>{this.toIndexRange(s,n).forEach(c=>{const d=this.getByIndex(o,c);d&&r.push(d)})}),r}}function Ht({entity:i,match:t}){i.vel.x>0?i.bounds.right>t.x1&&i.obstruct(f.RIGHT,t):i.vel.x<0&&i.bounds.left<t.x2&&i.obstruct(f.LEFT,t)}function qt({entity:i,match:t}){i.vel.y>0?i.bounds.bottom>t.y1&&i.obstruct(f.BOTTOM,t):i.vel.y<0&&i.bounds.top<t.y2&&i.obstruct(f.TOP,t)}const Vt=[Ht,qt];function jt({entity:i,match:t}){i.vel.x>0?i.bounds.right>t.x1&&i.obstruct(f.RIGHT,t):i.vel.x<0&&i.bounds.left<t.x2&&i.obstruct(f.LEFT,t)}function It({entity:i,match:t,resolver:e,gameContext:s,level:n}){if(i.vel.y>0)i.bounds.bottom>t.y1&&i.obstruct(f.BOTTOM,t);else if(i.vel.y<0){if(i.player){e.matrix.delete(t.indexX,t.indexY);const o=s.entityFactory.goomba();o.vel.set(50,-400),o.pos.set(i.pos.x,t.y1),n.entities.add(o)}i.bounds.top<t.y2&&i.obstruct(f.TOP,t)}}const $t=[jt,It];function Z({entity:i,match:t,resolver:e}){if(!i.player)return;i.player.addCoins(1),e.matrix.delete(t.indexX,t.indexY)}const Kt=[Z,Z],Wt={ground:Vt,brick:$t,coin:Kt};class Xt{constructor(){a(this,"resolvers");this.resolvers=[]}addGrid(t){this.resolvers.push(new dt(t))}checkX(t,e,s){let n;if(t.vel.x>0)n=t.bounds.right;else if(t.vel.x<0)n=t.bounds.left;else return;for(const r of this.resolvers)r.searchByRange(n,n,t.bounds.top,t.bounds.bottom).forEach(c=>{this._handle(0,t,c,r,e,s)})}checkY(t,e,s){let n;if(t.vel.y>0)n=t.bounds.bottom;else if(t.vel.y<0)n=t.bounds.top;else return;for(const r of this.resolvers)r.searchByRange(t.bounds.left,t.bounds.right,n,n).forEach(c=>{this._handle(1,t,c,r,e,s)})}_handle(t,e,s,n,r,o){if(!s.tile.type)return;const c={entity:e,match:s,resolver:n,gameContext:r,level:o},d=Wt[s.tile.type][t];d&&d(c)}}class lt{constructor(){a(this,"buffers");this.buffers=new Map}addAudio(t,e){this.buffers.set(t,e)}playAudio(t,e){const s=e.createBufferSource();s.connect(e.destination),s.buffer=this.buffers.get(t)||null,s.start(0)}}class Qt{constructor(t,e,s){a(this,"pos");a(this,"size");a(this,"offset");this.pos=t,this.size=e,this.offset=s}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}class Jt{constructor(){a(this,"events");this.events=[]}emit(t,...e){const s={name:t,args:e};this.events.push(s)}process(t,e){this.events.forEach(s=>{s.name===t&&e(...s.args)})}clear(){this.events.length=0}}const G=class G{constructor(t){a(this,"NAME");a(this,"listeners");this.NAME=t,this.listeners=[]}listen(t,e,s=1/0){const n={name:t,callback:e,count:s};this.listeners.push(n)}finalize(t){this.listeners=this.listeners.filter(e=>(t.events.process(e.name,e.callback),--e.count))}queue(t){this.listen(G.EVENT_TASK,t,1)}collides(t,e){}obstruct(t,e,s=void 0){}update(t,e,s=void 0){}};a(G,"EVENT_TASK",Symbol("task"));let u=G;class w{constructor(){a(this,"pos");a(this,"vel");a(this,"size");a(this,"offset");a(this,"bounds");a(this,"traits");a(this,"lifetime");a(this,"canCollide");a(this,"audio");a(this,"sounds");a(this,"events");a(this,"turbo");this.canCollide=!0,this.pos=new T(0,0),this.vel=new T(0,0),this.size=new T(0,0),this.offset=new T(0,0),this.bounds=new Qt(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[],this.audio=new lt,this.sounds=new Set,this.events=new Jt}addTrait(t){this.traits.push(t),this[t.NAME]=t}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}obstruct(t,e=void 0){this.traits.forEach(s=>{s.obstruct(this,t,e)})}playSound(t,e){this.sounds.forEach(s=>{t.playAudio(s,e)}),this.sounds.clear()}update(t,e){this.traits.forEach(s=>{s.update(this,t,e)}),this.playSound(this.audio,t.audioContext),this.lifetime+=t.deltaTime}draw(t){}finalize(){this.events.emit(u.EVENT_TASK,this),this.traits.forEach(t=>{t.finalize(this)}),this.events.clear()}}const _=class _ extends u{constructor(){super("stomper");a(this,"bounceSpeed");this.bounceSpeed=400}bounce(e,s){e.bounds.bottom=s.bounds.top,e.vel.y=-this.bounceSpeed}collides(e,s){!s.killable||s.killable.dead||e.vel.y>s.vel.y&&(this.queue(()=>this.bounce(e,s)),e.sounds.add("stomp"),e.events.emit(_.EVENT_STOMP,e,s))}};a(_,"EVENT_STOMP",Symbol("stomp"));let N=_;class Yt extends u{constructor(){super("player");a(this,"lives");a(this,"score");a(this,"coins");a(this,"name");this.name="UNNAMED",this.lives=3,this.score=0,this.coins=0,this.listen(N.EVENT_STOMP,()=>{this.score+=Ct})}addCoins(e){for(this.coins+=e,this.score+=Rt,this.queue(s=>s.sounds.add("coin"));this.coins>=U;)this.addLives(1),this.coins-=U,this.queue(s=>s.sounds.add("1up"))}addLives(e){this.lives+=e}}class Ut extends u{constructor(){super("playerController");a(this,"player");a(this,"checkpoint");this.checkpoint=new T(0,0),this.player=null}setPlayer(e){this.player=e}update(e,s,n){var r;if(this.player&&!n.entities.has(this.player)){(r=this.player.killable)==null||r.revive(),this.player.pos.set(this.checkpoint.x,this.checkpoint.y),n.entities.add(this.player);return}}}const Zt=function(i){const t=new w,e=new Ut;return e.checkpoint.set(v.x,v.y),e.setPlayer(i),t.addTrait(e),t},te=function(i){return i.addTrait(new Yt),i},H=function*(i){for(const t of i.entities)t.player&&(yield t)},ee=function(i){for(const t of H(i))i.camera.pos.x=Math.max(0,t.pos.x-100)};class q extends R{constructor(){super();a(this,"gravity");a(this,"name");a(this,"entities");a(this,"tiles");a(this,"tileCollider");a(this,"entityCollider");a(this,"totalTime");a(this,"music");a(this,"camera");this.name="",this.gravity=Et,this.totalTime=0,this.music=new Dt,this.entities=new Set,this.entityCollider=new Nt(this.entities),this.tileCollider=new Xt,this.camera=new ct}draw({videoContext:e}){this.comp.draw(e,this.camera)}update(e){this.entities.forEach(s=>{this.tileCollider&&s.update(e,this)}),this.entities.forEach(s=>{this.entityCollider.check(s)}),this.entities.forEach(s=>{s.finalize()}),ee(this),e.deltaTime&&(this.totalTime+=e.deltaTime)}pause(){this.music.pause()}}a(q,"EVENT_TRIGGER",Symbol("trigger"));class ut{constructor(t,e,s){a(this,"image");a(this,"width");a(this,"height");a(this,"tiles");a(this,"animations");this.image=t,this.width=e,this.height=s,this.tiles=new Map,this.animations=new Map}defineAnim(t,e){this.animations.set(t,e)}define(t,e,s,n,r){const o=[!1,!0].map(c=>{const d=document.createElement("canvas");d.width=n,d.height=r;const l=d.getContext("2d");return c&&(l.scale(-1,1),l.translate(-n,0)),l.drawImage(this.image,e,s,n,r,0,0,n,r),d});this.tiles.set(t,o)}defineTile(t,e,s){this.define(t,e*this.width,s*this.height,this.width,this.height)}draw(t,e,s,n,r=!1){const o=this.tiles.get(t);o&&e.drawImage(o[Number(r)],s,n)}drawAnim(t,e,s,n,r){const o=this.animations.get(t);this.drawTile(o(r),e,s,n)}drawTile(t,e,s,n){this.draw(t,e,s*this.width,n*this.height)}}const A=async function(i){var n,r,o;const t=await P(`/data/sprites/${i}.json`),e=await pt(t.imageURL),s=new ut(e,t.tileW||O,t.tileH||O);return(n=t.tiles)==null||n.forEach(c=>{s.defineTile(c.name,c.index[0],c.index[1])}),(r=t.frames)==null||r.forEach(c=>{s.define(c.name,...c.rect)}),(o=t.animations)==null||o.forEach(c=>{const d=Bt(c.frames,c.frameLen);s.defineAnim(c.name,d)}),s};class V extends u{constructor(){super("killable");a(this,"dead");a(this,"deadTime");a(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>this.dead=!0)}revive(){this.dead=!1,this.deadTime=0}update(e,{deltaTime:s},n){this.dead&&(this.deadTime+=s,!(this.deadTime<=this.removeAfter)&&this.queue(()=>{n.entities.delete(e)}))}}class se extends u{constructor(){super("velocity")}update(t,{deltaTime:e}){t.pos.x+=t.vel.x*e,t.pos.y+=t.vel.y*e}}class ie extends u{constructor(){super("gravity")}update(t,{deltaTime:e},s){t.vel.y+=s.gravity*e}}const ne=async function(i){return A("bullet").then(re)};let oe=class extends u{constructor(){super("behavior");a(this,"gravity");this.gravity=new ie}collides(e,s){var n;if(!e.killable.dead&&s.stomper){if(s.vel.y<=e.vel.y){(n=s.killable)==null||n.kill();return}e.killable.kill(),e.vel.set(M.x,M.y)}}update(e,s,n){e.killable.dead&&this.gravity.update(e,s,n)}};const re=function(i){const t=function(e){i.draw("bullet",e,0,0,this.vel.x<0)};return function(){const s=new w;return s.size.set(K.w,K.h),s.addTrait(new se),s.addTrait(new oe),s.addTrait(new V),s.draw=t,s}};async function ht(i,t){const e=ae(t),s=await P(`/data/sounds/${i}.json`),n=new lt,r=s.fx,o=[];return Object.keys(r).forEach(d=>{const{url:l}=r[d],p=e(l).then(h=>{n.addAudio(d,h)});o.push(p)}),Promise.all(o).then(()=>n)}function ae(i){return async function(e){return fetch(e).then(s=>s.arrayBuffer()).then(s=>i.decodeAudioData(s))}}class ce extends u{constructor(){super("emitter");a(this,"interval");a(this,"coolDown");a(this,"emitters");this.interval=4,this.coolDown=this.interval,this.emitters=[]}emit(e,s,n){for(const r of this.emitters)r(e,s,n)}update(e,s,n){s.deltaTime&&(this.coolDown-=s.deltaTime),!(this.coolDown>0)&&(this.emit(e,s,n),this.coolDown=this.interval)}}const de=async function(i){const t=await ht("cannon",i);return le(t)},le=function(i){const t=function(e,{entityFactory:s},n){let r=1;for(const c of H(n)){if(c.pos.x>e.pos.x-Y&&c.pos.x<e.pos.x+Y)return;c.pos.x<e.pos.x&&(r=-1)}const o=s.bullet();o.pos.copy(e.pos),o.vel.set(80*r,0),e.sounds.add("shoot"),n.entities.add(o)};return function(){const s=new w;s.audio=i;const n=new ce;return n.emitters.push(t),s.addTrait(n),s}};class ft extends u{constructor(){super("pendulumMove");a(this,"speed");a(this,"enabled");this.enabled=!0,this.speed=-30}obstruct(e,s){(s===f.LEFT||s===f.RIGHT)&&(this.speed=-this.speed)}update(e){this.enabled&&(e.vel.x=this.speed)}}class W extends u{constructor(){super("physics")}update(t,e,s){const{deltaTime:n}=e;t.pos.x+=t.vel.x*n,s.tileCollider.checkX(t,e,s),t.pos.y+=t.vel.y*n,s.tileCollider.checkY(t,e,s),t.vel.y+=s.gravity*n}}class X extends u{constructor(){super("solid");a(this,"obstructs");this.obstructs=!0}obstruct(e,s,n){this.obstructs&&(s===f.BOTTOM?(e.bounds.bottom=n.y1,e.vel.y=0):s===f.TOP?(e.bounds.top=n.y2,e.vel.y=0):s===f.LEFT?(e.bounds.left=n.x2,e.vel.x=0):s===f.RIGHT&&(e.bounds.right=n.x1,e.vel.x=0))}}const ue=async function(i){return A("goomba").then(fe)};let he=class extends u{constructor(){super("behavior")}collides(t,e){var s;if(!t.killable.dead&&e.stomper){if(e.vel.y<=t.vel.y){(s=e.killable)==null||s.kill();return}t.killable.kill(),t.pendulumMove.speed=0}}};const fe=function(i){const t=i.animations.get("walk"),e=function(n){return n.killable.dead?"flat":t(n.lifetime)},s=function(n){i.draw(e(this),n,0,0)};return function(){const r=new w;return r.size.set(k.w,k.h),r.addTrait(new W),r.addTrait(new X),r.addTrait(new ft),r.addTrait(new he),r.addTrait(new V),r.draw=s,r}},pe=async function(i){return A("koopa").then(ye)},z=Symbol("walking"),S=Symbol("hiding"),F=Symbol("panic");class me extends u{constructor(){super("behavior");a(this,"state");a(this,"hideTime");a(this,"hideDuration");a(this,"panicSpeed");a(this,"walkSpeed");this.hideTime=0,this.hideDuration=5,this.panicSpeed=300,this.walkSpeed=null,this.state=z}collides(e,s){if(!e.killable.dead&&s.stomper){if(s.vel.y<=e.vel.y){this.handleNudge(e,s);return}this.handleStomp(e,s)}}handleNudge(e,s){var n,r;if(this.state===z)(n=s.killable)==null||n.kill();else if(this.state===S)this.panic(e,s);else if(this.state===F){const o=Math.sign(e.vel.x),c=Math.sign(e.pos.x-s.pos.x);o!==0&&o!==c&&((r=s.killable)==null||r.kill())}}handleStomp(e,s){this.state===z?this.hide(e):this.state===S?(e.killable.kill(),e.vel.set(M.x,M.y),e.solid.obstructs=!1):this.state===F&&this.hide(e)}hide(e){e.vel.x=0,e.pendulumMove.enabled=!1,this.walkSpeed===null&&(this.walkSpeed=e.pendulumMove.speed),this.hideTime=0,this.state=S}unhide(e){e.pendulumMove.enabled=!0,this.walkSpeed&&(e.pendulumMove.speed=this.walkSpeed),this.state=z}panic(e,s){e.pendulumMove.enabled=!0,e.pendulumMove.speed=this.panicSpeed*Math.sign(s.vel.x),this.state=F}update(e,{deltaTime:s}){this.state===S&&(this.hideTime+=s,!(this.hideTime<=this.hideDuration)&&this.unhide(e))}}const ye=function(i){const t=i.animations.get("walk"),e=i.animations.get("wake"),s=function(r){const o=r.behavior;return o.state===S?o.hideTime>3?e(o.hideTime):"hiding":o.state===F?"hiding":t(r.lifetime)},n=function(r){i.draw(s(this),r,0,0,this.vel.x<0)};return function(){const o=new w;return o.size.set(k.w,k.h),o.offset.y=8,o.addTrait(new W),o.addTrait(new X),o.addTrait(new ft),o.addTrait(new me),o.addTrait(new V),o.draw=n,o}};class we extends u{constructor(){super("go");a(this,"dir");a(this,"acceleration");a(this,"deceleration");a(this,"dragFactor");a(this,"distance");a(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=it,this.distance=0,this.heading=1}update(e,{deltaTime:s}){const n=Math.abs(e.vel.x);if(this.dir!==0)e.vel.x+=this.acceleration*s*this.dir,e.jump?e.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(e.vel.x!==0){const o=Math.min(n,this.deceleration*s);e.vel.x+=e.vel.x>0?-o:o}else this.distance=0;const r=this.dragFactor*e.vel.x*n;e.vel.x-=r,this.distance+=n*s}}class ge extends u{constructor(){super("jump");a(this,"duration");a(this,"velocity");a(this,"engageTime");a(this,"ready");a(this,"requestTime");a(this,"gracePeriod");a(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(e,s){s===f.BOTTOM?this.ready=1:s===f.TOP&&this.cancel()}update(e,{deltaTime:s}){this.requestTime>0&&(this.ready>0&&(e.sounds.add("jump"),this.engageTime=this.duration,this.requestTime=0),this.requestTime-=s),this.engageTime>0&&(e.vel.y=-(this.velocity+Math.abs(e.vel.x)*this.speedBoost),this.engageTime-=s),this.ready--}}const ve=async function(i){const t=await A("mario"),e=await ht("mario",i);return Te(t,e)},Te=function(i,t){const e=i.animations.get("run");function s(o){return o.jump.falling?"jump":o.go.distance>0?o.vel.x>0&&o.go.dir<0||o.vel.x<0&&o.go.dir>0?"break":e(o.go.distance):"idle"}function n(o){this.go.dragFactor=o?Mt:it}function r(o){i.draw(s(this),o,0,0,this.go.heading<0)}return function(){const c=new w;return c.audio=t,c.size.set($.w,$.h),c.addTrait(new W),c.addTrait(new X),c.addTrait(new we),c.addTrait(new ge),c.addTrait(new N),c.addTrait(new V),c.killable.removeAfter=0,c.turbo=n,c.draw=r,c.turbo(!1),c}},pt=function(i){return new Promise(t=>{const e=new Image;e.addEventListener("load",()=>{t(e)}),e.src=i})},P=async function(i){return fetch(i).then(t=>t.json())},be=async function(i){const t={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")},bullet:function(){throw new Error("Function not implemented.")},cannon:function(){throw new Error("Function not implemented.")}},e=function(s){return n=>t[s]=n};return Promise.all([ve(i).then(e("mario")),ue().then(e("goomba")),pe().then(e("koopa")),ne().then(e("bullet")),de(i).then(e("cannon"))]).then(()=>t)},xe=function(i,t,e){const s=new dt(t),n=document.createElement("canvas");n.width=et+16,n.height=st;const r=n.getContext("2d");function o(c,d){r.clearRect(0,0,n.width,n.height);for(let l=c;l<=d;++l){const p=t.grid[l];p&&p.forEach((h,g)=>{const b=h;e.animations.has(b.name)?e.drawAnim(b.name,r,l-c,g,i.totalTime):e.drawTile(b.name,r,l-c,g)})}}return function(d,l){const p=s.toIndex(l.size.x),h=s.toIndex(l.pos.x),g=h+p;o(h,g),d.drawImage(n,-l.pos.x%O,-l.pos.y)}},Ee=function(i,t=C.width,e=C.width){const s=document.createElement("canvas");s.width=t,s.height=e;const n=s.getContext("2d");return function(o,c){i.forEach(d=>{n.clearRect(0,0,t,e),d.draw(n),o.drawImage(s,d.pos.x-c.pos.x,d.pos.y-c.pos.y)})}};class Se{constructor(){a(this,"tracks");this.tracks=new Map}addTrack(t,e){const s=new Audio;s.loop=!0,s.src=e,this.tracks.set(t,s)}playTrack(t){this.pauseAll();const e=this.tracks.get(t);return e.play(),e}pauseAll(){for(const t of this.tracks.values())t.pause()}}async function ke(i){const t=await P(`/data/music/${i}.json`),e=new Se;for(const[s,n]of Object.entries(t))e.addTrack(s,n.url);return e}const x=class x extends u{constructor(){super("levelTimer");a(this,"totalTime");a(this,"currentTime");a(this,"hurryTime");a(this,"hurryEmitted");this.totalTime=300,this.currentTime=this.totalTime,this.hurryTime=100,this.hurryEmitted=null}update(e,{deltaTime:s},n){this.currentTime-=s*2,this.hurryEmitted!==!0&&this.currentTime<this.hurryTime&&(n==null||n.events.emit(x.EVENT_TIMER_HURRY),this.hurryEmitted=!0),this.hurryEmitted!==!1&&this.currentTime>this.hurryTime&&(n==null||n.events.emit(x.EVENT_TIMER_OK),this.hurryEmitted=!1)}};a(x,"EVENT_TIMER_HURRY",Symbol("timer hurry")),a(x,"EVENT_TIMER_OK",Symbol("timer ok"));let L=x;class Me extends u{constructor(){super("trigger");a(this,"touches");a(this,"conditions");this.touches=new Set,this.conditions=[]}collides(e,s){this.touches.add(s)}update(e,s,n){if(this.touches.size>0){for(const r of this.conditions)r(e,this.touches,s,n);this.touches.clear()}}}const Ce=function(){const i=new w;return i.addTrait(new L),i},Re=function(i){const t=Ce();i.entities.add(t),i.events.listen(L.EVENT_TIMER_OK,()=>{i.music.playTheme()}),i.events.listen(L.EVENT_TIMER_HURRY,()=>{i.music.playHurryTheme()})},I=function*(i,t,e,s){const n=i+t,r=e+s;for(let o=i;o<n;++o)for(let c=e;c<r;++c)yield{x:o,y:c}},Le=function(i){if(i.length===4){const[t,e,s,n]=i;return I(t,e,s,n)}else if(i.length===3){const[t,e,s]=i;return I(t,e,s,1)}else{const[t,e]=i;return I(t,1,e,1)}},Ae=function*(i){for(const t of i)yield*Le(t)},Pe=function*(i,t){function*e(s,n,r){for(const o of s)for(const{x:c,y:d}of Ae(o.ranges)){const l=c+n,p=d+r;if(o.pattern){const h=t[o.pattern];yield*e(h.tiles,l,p);continue}yield{tile:o,x:l,y:p}}}yield*e(i,0,0)},Be=function(i,t){const e=new Ot;for(const{tile:s,x:n,y:r}of Pe(i,t))e.set(n,r,s);return e},ze=function(i,t,e,s){i.layers.forEach(n=>{const r=Be(n.tiles,s),o=xe(t,r,e);t.comp.layers.push(o),t.tileCollider.addGrid(r)})},Fe=function(i,t,e){i.entities.forEach(({name:n,pos:[r,o]})=>{const c=e[n],d=c();d.pos.set(r,o),t.entities.add(d)});const s=Ee(t.entities);t.comp.layers.push(s)},Oe=async function(i){return await P(`/data/patterns/${i}.json`)},Ne=function(){const i=new w;return i.addTrait(new Me),i},De=function(i,t){var e;if(i.triggers)for(const s of i.triggers){const n=Ne();(e=n.trigger)==null||e.conditions.push((r,o,c,d)=>{d.events.emit(q.EVENT_TRIGGER,s,r,o)}),n.size.set(96,192),n.pos.set(s.pos[0],s.pos[1]),t.entities.add(n)}},Ge=async function(i){return async function(e){const s=await P(`/data/levels/${e}.json`),n=await A(s.spriteSheet),r=await ke(s.musicSheet),o=await Oe(s.patternSheet),c=new q;return c.name=e,c.music.setPlayer(r),ze(s,c,n,o),Fe(s,c,i),De(s,c),Re(c),c}},_e=function(){const i=document.querySelector("[data-action='left']"),t=document.querySelector("[data-action='right']"),e=document.querySelector("[data-action='jump']"),s=document.querySelector("[data-action='speed']"),n=new tt,r={left:{elem:i,fn:function(c){at(c,n)},handle:!1},right:{elem:t,fn:function(c){rt(c,n)},handle:!1},jump:{elem:e,fn:function(c){nt(c,n)},handle:!1},speed:{elem:s,fn:function(c){ot(c,n)},handle:!1}};return["pointerdown","pointerup","pointercancel","pointerout","pointerleave"].forEach(c=>{for(const d in r){const l=r[d];l.elem.addEventListener(c,function(){if(c==="pointerdown")return l.handle=!0,l.fn(!0);l.handle&&(l.fn(!1),l.handle=!1)})}}),n};function He(i){return[...i].includes(i)}class qe{constructor(t,e=y){a(this,"sprites");a(this,"size",y);this.sprites=t,this.size=e}print(t,e,s,n){[...t].forEach((r,o)=>{He(r)&&this.sprites.draw(r,e,s+o*this.size,n)})}}const Ve=async function(){return pt(Lt).then(i=>{const t=new ut(i,y,y),e=i.width;for(const[s,n]of[...At].entries()){const r=s*y%e,o=Math.floor(s*y/e)*y;t.define(n,r,o,y,y)}return new qe(t)})},je=function(i){for(const t of H(i))return t.player},Ie=function(i){for(const t of i.entities)if(t.levelTimer)return t.levelTimer},$e=function(i,t){const e=i.size,s=i.size*2,n=Ie(t);return function(o){const c=je(t);if(!c||!n)return;const{score:d,coins:l,name:p,lives:h}=c;i.print(p,o,16,e),i.print(d.toString().padStart(6,"0"),o,16,s),i.print(`livesx${h.toString().padStart(2,"0")}`,o,80,e),i.print(`@x${l.toString().padStart(2,"0")}`,o,96,s),i.print("WORLD",o,152,e),i.print(t.name,o,160,s),i.print("TIME",o,208,e),i.print(n.currentTime.toFixed().toString().padStart(3,"0"),o,216,s)}};class Ke{constructor(){a(this,"sceneIndex");a(this,"scenes");this.sceneIndex=-1,this.scenes=[]}addScene(t){t.events.listen(R.EVENT_COMPLETE,()=>{this.runNext()}),this.scenes.push(t)}runNext(){this.sceneIndex++}reset(){for(const t of this.scenes)t.pause();this.scenes.length=0,this.sceneIndex=-1}update(t){const e=this.scenes[this.sceneIndex];e&&(e.update(t),e.draw(t))}}const We=function(i){for(const t of H(i))return t},Xe=function(i,t){const e=i.size,s=document.createElement("canvas");s.width=C.width,s.height=C.height;const n=s.getContext("2d");return function(o){var d;const c=We(t);c&&(i.print(`WORLD ${t.name}`,o,e*12,e*12),n.clearRect(0,0,s.width,s.height),c.draw(n),o.drawImage(s,e*12,e*15),i.print(`x ${(d=c.player)==null?void 0:d.lives.toString().padStart(3," ")}`,o,e*16,e*16))}},Qe=function(i){return function(e,s){e.strokeStyle="red",i.forEach(n=>{e.beginPath(),e.rect(n.bounds.left-s.pos.x,n.bounds.top-s.pos.y,n.size.x,n.size.y),e.stroke()})}},Je=function(i){const t=[],e=i.tileSize,s=i.getByIndex;return i.getByIndex=function(r,o){return t.push({x:r,y:o}),s.call(i,r,o)},function(r,o){r.strokeStyle="blue",t.forEach(({x:c,y:d})=>{r.beginPath(),r.rect(c*e-o.pos.x,d*e-o.pos.y,e,e),r.stroke()}),t.length=0}};function Ye(i){if(!i.tileCollider)return;const t=i.tileCollider.resolvers.map(Je),e=Qe(i.entities);return function(n,r){t.forEach(o=>o(n,r)),e(n,r)}}class Ue extends R{constructor(){super();a(this,"countDown");this.countDown=2}update({deltaTime:e}){this.countDown-=e,this.countDown<=0&&this.events.emit(R.EVENT_COMPLETE)}}const Ze=function(i){return function(e){e.fillStyle=i,e.fillRect(0,0,e.canvas.width,e.canvas.height)}},ts=async function(i){const t=i.getContext("2d"),e=new AudioContext,[s,n]=await Promise.all([be(e),Ve()]),r=await Ge(s),o=te(s.mario());o.player.name="MARIO",o.pos.set(v.x,v.y),zt(window).addReceiver(o),_e().addReceiver(o);const l=async function(b){h.reset();const m=await r(b);m.events.listen(q.EVENT_TRIGGER,(J,es,vt)=>{if(J.type==="goto"){for(const Tt of vt)if(Tt.player){l(J.name);return}}});const yt=Xe(n,m),wt=$e(n,m);o.pos.set(v.x,v.y),m.entities.add(o);const gt=Zt(o);m.entities.add(gt);const B=new Ue;B.countDown=2,B.comp.layers.push(Ze("#000")),B.comp.layers.push(yt),h.addScene(B);const Q=Ye(m);Q&&m.comp.layers.push(Q),m.comp.layers.push(wt),h.addScene(m),console.log(h),h.runNext()},p={audioContext:e,videoContext:t,entityFactory:s,deltaTime:0},h=new Ke,g=new Ft;g.update=function(m){p.deltaTime=m,h.update(p)},g.start(),l("1-1")},D=document.getElementById("screen"),j=D.getContext("2d");j.font="30px Comic Sans MS";j.fillStyle="white";j.textAlign="center";j.fillText("Hit Click To Play",D.width/2,D.height/2);const mt=function(){window.removeEventListener("click",mt),ts(D)};window.addEventListener("click",mt);
