var it=Object.defineProperty;var nt=(i,e,t)=>e in i?it(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var a=(i,e,t)=>(nt(i,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const L=16,m=8;var F=(i=>(i[i.x=64]="x",i[i.y=64]="y",i))(F||{}),P=(i=>(i[i.w=14]="w",i[i.h=16]="h",i))(P||{}),k=(i=>(i[i.w=16]="w",i[i.h=16]="h",i))(k||{}),R=(i=>(i[i.w=16]="w",i[i.h=14]="h",i))(R||{}),T=(i=>(i[i.x=100]="x",i[i.y=-200]="y",i))(T||{});const ot=1500,rt=1,at=0;var b=(i=>(i.SPACE="Space",i.ARROW_RIGHT="ArrowRight",i.ARROW_LEFT="ArrowLeft",i.SPEED_X="KeyX",i))(b||{});const H=256,N=256;var G=(i=>(i[i.width=64]="width",i[i.height=64]="height",i))(G||{});const W=.001,ct=2e-4,f={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")},lt=100,dt="./assets/img/font-coin.png",ut=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",j=30;class ht{constructor(){a(this,"keyStates");a(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(e,t){this.keyMap.set(e,t)}handleEvent(e){const{code:t}=e;if(!this.keyMap.has(t))return;e.preventDefault();const s=e.type==="keydown"?rt:at;this.keyStates.get(t)!==s&&(this.keyStates.set(t,s),this.keyMap.get(t)(s))}listenTo(e){["keydown","keyup"].forEach(s=>{e.addEventListener(s,n=>{this.handleEvent(n)})})}}const X=function(i,e){e?i.jump.start():i.jump.cancel()},$=function(i,e){i.turbo&&i.turbo(e)},K=function(i,e){i.go.dir+=e?1:-1},_=function(i,e){i.go.dir+=e?-1:1},ft=function(i,e){return function(s){const n=Math.floor(s/e)%i.length;return i[n]}},pt=function(i){const e=new ht;return e.addMapping(b.SPACE,t=>{X(i,t)}),e.addMapping(b.SPEED_X,t=>{$(i,t)}),e.addMapping(b.ARROW_RIGHT,t=>{K(i,t)}),e.addMapping(b.ARROW_LEFT,t=>{_(i,t)}),e};class mt{constructor(e=1/60){a(this,"update");a(this,"updateProxy");let t=0,s=0;this.updateProxy=n=>{for(t+=(n-s)/1e3,t>1&&(t=1);t>e;)this.update(e),t-=e;s=n,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class V{constructor(){a(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((t,s)=>{t.forEach((n,o)=>{e(n,s,o)})})}get(e,t){const s=this.grid[e];if(s)return s[t]}set(e,t,s){this.grid[e]||(this.grid[e]=[]),this.grid[e][t]=s}}class w{constructor(e,t){a(this,"x");a(this,"y");this.set(e,t)}copy(e){this.x=e.x,this.y=e.y}set(e,t){this.x=e,this.y=t}}class yt{constructor(){a(this,"pos");a(this,"size");this.pos=new w(0,0),this.size=new w(H,N)}}class wt{constructor(){a(this,"layers");this.layers=[]}draw(e,t){this.layers.forEach(s=>{s(e,t)})}}class gt{constructor(e){a(this,"entities");this.entities=e}check(e){this.entities.forEach(t=>{e!==t&&e.bounds.overlaps(t.bounds)&&(e.collides(t),t.collides(e))})}}class Q{constructor(e,t=L){a(this,"matrix");a(this,"tileSize");this.matrix=e,this.tileSize=t}toIndex(e){return Math.floor(e/this.tileSize)}toIndexRange(e,t){const s=Math.ceil(t/this.tileSize)*this.tileSize,n=[];let o=e;do n.push(this.toIndex(o)),o+=this.tileSize;while(o<s);return n}getByIndex(e,t){const s=this.matrix.get(e,t);if(s){const n=e*this.tileSize,o=n+this.tileSize,r=t*this.tileSize,c=r+this.tileSize;return{tile:s,x1:n,x2:o,y1:r,y2:c}}}searchByPosition(e,t){return this.getByIndex(this.toIndex(e),this.toIndex(t))}searchByRange(e,t,s,n){const o=[];return this.toIndexRange(e,t).forEach(r=>{this.toIndexRange(s,n).forEach(c=>{const l=this.getByIndex(r,c);l&&o.push(l)})}),o}}function vt(i,e){i.vel.x>0?i.bounds.right>e.x1&&i.obstruct(f.RIGHT,e):i.vel.x<0&&i.bounds.left<e.x2&&i.obstruct(f.LEFT,e)}function bt(i,e){i.vel.y>0?i.bounds.bottom>e.y1&&i.obstruct(f.BOTTOM,e):i.vel.y<0&&i.bounds.top<e.y2&&i.obstruct(f.TOP,e)}const xt=[vt,bt],kt={ground:xt};class Tt{constructor(e){a(this,"tiles");this.tiles=new Q(e)}checkX(e){let t;if(e.vel.x>0)t=e.bounds.right;else if(e.vel.x<0)t=e.bounds.left;else return;this.tiles.searchByRange(t,t,e.bounds.top,e.bounds.bottom).forEach(n=>{this._handle(0,e,n)})}checkY(e){let t;if(e.vel.y>0)t=e.bounds.bottom;else if(e.vel.y<0)t=e.bounds.top;else return;this.tiles.searchByRange(e.bounds.left,e.bounds.right,t,t).forEach(n=>{this._handle(1,e,n)})}_handle(e,t,s){if(!s.tile.type)return;const n=kt[s.tile.type][e];n&&n(t,s)}}class Et{constructor(){a(this,"gravity");a(this,"comp");a(this,"entities");a(this,"tiles");a(this,"tileCollider");a(this,"entityCollider");a(this,"totalTime");this.gravity=ot,this.totalTime=0,this.comp=new wt,this.entities=new Set,this.entityCollider=new gt(this.entities),this.tileCollider=null}setCollisionGrid(e){this.tileCollider=new Tt(e)}update(e){this.entities.forEach(t=>{this.tileCollider&&t.update(e,this)}),this.entities.forEach(t=>{this.entityCollider.check(t)}),this.entities.forEach(t=>{t.finalize()}),this.totalTime+=e.deltaTime}}class J{constructor(e,t,s){a(this,"image");a(this,"width");a(this,"height");a(this,"tiles");a(this,"animations");this.image=e,this.width=t,this.height=s,this.tiles=new Map,this.animations=new Map}defineAnim(e,t){this.animations.set(e,t)}define(e,t,s,n,o){const r=[!1,!0].map(c=>{const l=document.createElement("canvas");l.width=n,l.height=o;const d=l.getContext("2d");return c&&(d.scale(-1,1),d.translate(-n,0)),d.drawImage(this.image,t,s,n,o,0,0,n,o),l});this.tiles.set(e,r)}defineTile(e,t,s){this.define(e,t*this.width,s*this.height,this.width,this.height)}draw(e,t,s,n,o=!1){const r=this.tiles.get(e);r&&t.drawImage(r[Number(o)],s,n)}drawAnim(e,t,s,n,o){const r=this.animations.get(e);this.drawTile(r(o),t,s,n)}drawTile(e,t,s,n){this.draw(e,t,s*this.width,n*this.height)}}class I{constructor(){a(this,"buffers");this.buffers=new Map}addAudio(e,t){this.buffers.set(e,t)}playAudio(e,t){const s=t.createBufferSource();s.connect(t.destination),s.buffer=this.buffers.get(e)||null,s.start(0)}}class St{constructor(e,t,s){a(this,"pos");a(this,"size");a(this,"offset");this.pos=e,this.size=t,this.offset=s}overlaps(e){return this.bottom>e.top&&this.top<e.bottom&&this.left<e.right&&this.right>e.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(e){this.pos.y=e-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(e){this.pos.y=e-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(e){this.pos.x=e-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(e){this.pos.x=e-(this.size.x+this.offset.x)}}class Ct{constructor(){a(this,"listeners");this.listeners=[]}listen(e,t){const s={name:e,callback:t};this.listeners.push(s)}emit(e,...t){this.listeners.forEach(s=>{s.name===e&&s.callback(...t)})}}class u{constructor(e){a(this,"NAME");a(this,"tasks");a(this,"events");this.NAME=e,this.tasks=[],this.events=new Ct}finalize(){this.tasks.forEach(e=>e()),this.tasks.length=0}queue(e){this.tasks.push(e)}collides(e,t){}obstruct(e,t,s=void 0){}update(e,t,s=void 0){}}class v{constructor(){a(this,"pos");a(this,"vel");a(this,"size");a(this,"offset");a(this,"bounds");a(this,"traits");a(this,"lifetime");a(this,"canCollide");a(this,"audio");a(this,"sounds");a(this,"turbo");this.canCollide=!0,this.pos=new w(0,0),this.vel=new w(0,0),this.size=new w(0,0),this.offset=new w(0,0),this.bounds=new St(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[],this.audio=new I,this.sounds=new Set}addTrait(e){this.traits.push(e),this[e.NAME]=e}collides(e){this.traits.forEach(t=>{t.collides(this,e)})}obstruct(e,t=void 0){this.traits.forEach(s=>{s.obstruct(this,e,t)})}playSound(e,t){this.sounds.forEach(s=>{e.playAudio(s,t)}),this.sounds.clear()}update(e,t){this.traits.forEach(s=>{s.update(this,e,t)}),this.playSound(this.audio,e.audioContext),this.lifetime+=e.deltaTime}draw(e){}finalize(){this.traits.forEach(e=>{e.finalize()})}}class M extends u{constructor(){super("killable");a(this,"dead");a(this,"deadTime");a(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>this.dead=!0)}revive(){this.dead=!1,this.deadTime=0}update(t,{deltaTime:s},n){this.dead&&(this.deadTime+=s,!(this.deadTime<=this.removeAfter)&&this.queue(()=>{n.entities.delete(t)}))}}class Lt extends u{constructor(){super("velocity")}update(e,{deltaTime:t}){e.pos.x+=e.vel.x*t,e.pos.y+=e.vel.y*t}}class At extends u{constructor(){super("gravity")}update(e,{deltaTime:t},s){e.vel.y+=s.gravity*t}}const Mt=async function(i){return E("bullet").then(zt)};let Bt=class extends u{constructor(){super("behavior");a(this,"gravity");this.gravity=new At}collides(t,s){var n;if(!t.killable.dead&&s.stomper){if(s.vel.y<=t.vel.y){(n=s.killable)==null||n.kill();return}t.killable.kill(),t.vel.set(T.x,T.y)}}update(t,s,n){t.killable.dead&&this.gravity.update(t,s,n)}};const zt=function(i){const e=function(t){i.draw("bullet",t,0,0,this.vel.x<0)};return function(){const s=new v;return s.size.set(R.w,R.h),s.addTrait(new Lt),s.addTrait(new Bt),s.addTrait(new M),s.draw=e,s}};async function Z(i,e){const t=Ft(e),s=await q(`/data/sounds/${i}.json`),n=new I,o=s.fx,r=[];return Object.keys(o).forEach(l=>{const{url:d}=o[l],h=t(`/assets/audio/${d}`).then(p=>{n.addAudio(l,p)});r.push(h)}),Promise.all(r).then(()=>n)}function Ft(i){return async function(t){return fetch(t).then(s=>s.arrayBuffer()).then(s=>i.decodeAudioData(s))}}class Pt extends u{constructor(){super("emitter");a(this,"interval");a(this,"coolDown");a(this,"emitters");this.interval=4,this.coolDown=this.interval,this.emitters=[]}emit(t,s){for(const n of this.emitters)n(t,s)}update(t,{deltaTime:s},n){this.coolDown-=s,!(this.coolDown>0)&&(this.emit(t,n),this.coolDown=this.interval)}}class Rt extends u{constructor(){super("player");a(this,"lives");a(this,"score");this.lives=3,this.score=0}}class Gt extends u{constructor(){super("playerController");a(this,"player");a(this,"checkpoint");a(this,"time");a(this,"score");this.checkpoint=new w(0,0),this.player=null,this.time=300,this.score=0}setPlayer(t){this.player=t,this.player.stomper&&this.player.stomper.events.listen("stomp",()=>{this.score+=lt})}update(t,{deltaTime:s},n){var o;if(this.player){if(!n.entities.has(this.player)){(o=this.player.killable)==null||o.revive(),this.player.pos.set(this.checkpoint.x,this.checkpoint.y),n.entities.add(this.player);return}this.time-=s*2}}}const Dt=function(i){const e=new v,t=new Gt;return t.checkpoint.set(F.x,F.y),t.setPlayer(i),e.addTrait(t),e},Ot=function(i){return i.addTrait(new Rt),i},qt=function*(i){for(const e of i.entities)e.player&&(yield e)},jt=async function(i,e){const t=await Z("cannon",i);return Ht(t,e)},Ht=function(i,e){const t=function(s,n){let o=1;for(const c of qt(n)){if(c.pos.x>s.pos.x-j&&c.pos.x<s.pos.x+j)return;c.pos.x<s.pos.x&&(o=-1)}const r=e.bullet();r.pos.copy(s.pos),r.vel.set(80*o,0),s.sounds.add("shoot"),n.entities.add(r)};return function(){const n=new v;n.audio=i;const o=new Pt;return o.emitters.push(t),n.addTrait(o),n}};class U extends u{constructor(){super("pendulumMove");a(this,"speed");a(this,"enabled");this.enabled=!0,this.speed=-30}obstruct(t,s){(s===f.LEFT||s===f.RIGHT)&&(this.speed=-this.speed)}update(t){this.enabled&&(t.vel.x=this.speed)}}class D extends u{constructor(){super("physics")}update(e,{deltaTime:t},s){e.pos.x+=e.vel.x*t,s.tileCollider.checkX(e),e.pos.y+=e.vel.y*t,s.tileCollider.checkY(e),e.vel.y+=s.gravity*t}}class O extends u{constructor(){super("solid");a(this,"obstructs");this.obstructs=!0}obstruct(t,s,n){this.obstructs&&(s===f.BOTTOM?(t.bounds.bottom=n.y1,t.vel.y=0):s===f.TOP?(t.bounds.top=n.y2,t.vel.y=0):s===f.LEFT?(t.bounds.left=n.x2,t.vel.x=0):s===f.RIGHT&&(t.bounds.right=n.x1,t.vel.x=0))}}const Nt=async function(i){return E("goomba").then(Xt)};let Wt=class extends u{constructor(){super("behavior")}collides(e,t){var s;if(!e.killable.dead&&t.stomper){if(t.vel.y<=e.vel.y){(s=t.killable)==null||s.kill();return}e.killable.kill(),e.pendulumMove.speed=0}}};const Xt=function(i){const e=i.animations.get("walk"),t=function(n){return n.killable.dead?"flat":e(n.lifetime)},s=function(n){i.draw(t(this),n,0,0)};return function(){const o=new v;return o.size.set(k.w,k.h),o.addTrait(new D),o.addTrait(new O),o.addTrait(new U),o.addTrait(new Wt),o.addTrait(new M),o.draw=s,o}},$t=async function(i){return E("koopa").then(_t)},S=Symbol("walking"),x=Symbol("hiding"),C=Symbol("panic");class Kt extends u{constructor(){super("behavior");a(this,"state");a(this,"hideTime");a(this,"hideDuration");a(this,"panicSpeed");a(this,"walkSpeed");this.hideTime=0,this.hideDuration=5,this.panicSpeed=300,this.walkSpeed=null,this.state=S}collides(t,s){if(!t.killable.dead&&s.stomper){if(s.vel.y<=t.vel.y){this.handleNudge(t,s);return}this.handleStomp(t,s)}}handleNudge(t,s){var n,o;if(this.state===S)(n=s.killable)==null||n.kill();else if(this.state===x)this.panic(t,s);else if(this.state===C){const r=Math.sign(t.vel.x),c=Math.sign(t.pos.x-s.pos.x);r!==0&&r!==c&&((o=s.killable)==null||o.kill())}}handleStomp(t,s){this.state===S?this.hide(t):this.state===x?(t.killable.kill(),t.vel.set(T.x,T.y),t.solid.obstructs=!1):this.state===C&&this.hide(t)}hide(t){t.vel.x=0,t.pendulumMove.enabled=!1,this.walkSpeed===null&&(this.walkSpeed=t.pendulumMove.speed),this.hideTime=0,this.state=x}unhide(t){t.pendulumMove.enabled=!0,this.walkSpeed&&(t.pendulumMove.speed=this.walkSpeed),this.state=S}panic(t,s){t.pendulumMove.enabled=!0,t.pendulumMove.speed=this.panicSpeed*Math.sign(s.vel.x),this.state=C}update(t,{deltaTime:s}){this.state===x&&(this.hideTime+=s,!(this.hideTime<=this.hideDuration)&&this.unhide(t))}}const _t=function(i){const e=i.animations.get("walk"),t=i.animations.get("wake"),s=function(o){const r=o.behavior;return r.state===x?r.hideTime>3?t(r.hideTime):"hiding":r.state===C?"hiding":e(o.lifetime)},n=function(o){i.draw(s(this),o,0,0,this.vel.x<0)};return function(){const r=new v;return r.size.set(k.w,k.h),r.offset.y=8,r.addTrait(new D),r.addTrait(new O),r.addTrait(new U),r.addTrait(new Kt),r.addTrait(new M),r.draw=n,r}};class Vt extends u{constructor(){super("go");a(this,"dir");a(this,"acceleration");a(this,"deceleration");a(this,"dragFactor");a(this,"distance");a(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=W,this.distance=0,this.heading=1}update(t,{deltaTime:s}){const n=Math.abs(t.vel.x);if(this.dir!==0)t.vel.x+=this.acceleration*s*this.dir,t.jump?t.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(t.vel.x!==0){const r=Math.min(n,this.deceleration*s);t.vel.x+=t.vel.x>0?-r:r}else this.distance=0;const o=this.dragFactor*t.vel.x*n;t.vel.x-=o,this.distance+=n*s}}class Qt extends u{constructor(){super("jump");a(this,"duration");a(this,"velocity");a(this,"engageTime");a(this,"ready");a(this,"requestTime");a(this,"gracePeriod");a(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(t,s){s===f.BOTTOM?this.ready=1:s===f.TOP&&this.cancel()}update(t,{deltaTime:s}){this.requestTime>0&&(this.ready>0&&(t.sounds.add("jump"),this.engageTime=this.duration,this.requestTime=0),this.requestTime-=s),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),this.engageTime-=s),this.ready--}}class Jt extends u{constructor(){super("stomper");a(this,"bounceSpeed");this.bounceSpeed=400}bounce(t,s){t.bounds.bottom=s.bounds.top,t.vel.y=-this.bounceSpeed}collides(t,s){!s.killable||s.killable.dead||t.vel.y>s.vel.y&&(this.queue(()=>this.bounce(t,s)),t.sounds.add("stomp"),this.events.emit("stomp",t,s))}}const It=async function(i){const e=await E("mario"),t=await Z("mario",i);return Zt(e,t)},Zt=function(i,e){const t=i.animations.get("run");function s(r){return r.jump.falling?"jump":r.go.distance>0?r.vel.x>0&&r.go.dir<0||r.vel.x<0&&r.go.dir>0?"break":t(r.go.distance):"idle"}function n(r){this.go.dragFactor=r?ct:W}function o(r){i.draw(s(this),r,0,0,this.go.heading<0)}return function(){const c=new v;return c.audio=e,c.size.set(P.w,P.h),c.addTrait(new D),c.addTrait(new O),c.addTrait(new Vt),c.addTrait(new Qt),c.addTrait(new Jt),c.addTrait(new M),c.killable.removeAfter=0,c.turbo=n,c.draw=o,c.turbo(!1),c}},Y=function(i){return new Promise(e=>{const t=new Image;t.addEventListener("load",()=>{e(t)}),t.src=i})},q=async function(i){return fetch(i).then(e=>e.json())},E=async function(i){var n,o,r;const e=await q(`/data/sprites/${i}.json`),t=await Y(e.imageURL),s=new J(t,e.tileW||L,e.tileH||L);return(n=e.tiles)==null||n.forEach(c=>{s.defineTile(c.name,c.index[0],c.index[1])}),(o=e.frames)==null||o.forEach(c=>{s.define(c.name,...c.rect)}),(r=e.animations)==null||r.forEach(c=>{const l=ft(c.frames,c.frameLen);s.defineAnim(c.name,l)}),s},Ut=async function(i){const e={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")},bullet:function(){throw new Error("Function not implemented.")},cannon:function(){throw new Error("Function not implemented.")}},t=function(s){return n=>e[s]=n};return Promise.all([It(i).then(t("mario")),Nt().then(t("goomba")),$t().then(t("koopa")),Mt().then(t("bullet")),jt(i,e).then(t("cannon"))]).then(()=>e)},Yt=function(i,e,t){const s=new Q(e),n=document.createElement("canvas");n.width=H+16,n.height=N;const o=n.getContext("2d");function r(c,l){o.clearRect(0,0,n.width,n.height);for(let d=c;d<=l;++d){const h=e.grid[d];h&&h.forEach((p,y)=>{const g=p;t.animations.has(g.name)?t.drawAnim(g.name,o,d-c,y,i.totalTime):t.drawTile(g.name,o,d-c,y)})}}return function(l,d){const h=s.toIndex(d.size.x),p=s.toIndex(d.pos.x),y=p+h;r(p,y),l.drawImage(n,-d.pos.x%L,-d.pos.y)}},te=function(i,e=G.width,t=G.width){const s=document.createElement("canvas");s.width=e,s.height=t;const n=s.getContext("2d");return function(r,c){i.forEach(l=>{n.clearRect(0,0,e,t),l.draw(n),r.drawImage(s,l.pos.x-c.pos.x,l.pos.y-c.pos.y)})}},z=function*(i,e,t,s){const n=i+e,o=t+s;for(let r=i;r<n;++r)for(let c=t;c<o;++c)yield{x:r,y:c}},ee=function(i){if(i.length===4){const[e,t,s,n]=i;return z(e,t,s,n)}else if(i.length===3){const[e,t,s]=i;return z(e,t,s,1)}else{const[e,t]=i;return z(e,1,t,1)}},se=function*(i){for(const e of i)yield*ee(e)},tt=function*(i,e){function*t(s,n,o){for(const r of s)for(const{x:c,y:l}of se(r.ranges)){const d=c+n,h=l+o;if(r.pattern){const p=e[r.pattern];yield*t(p.tiles,d,h);continue}yield{tile:r,x:d,y:h}}}yield*t(i,0,0)},ie=function(i,e){const t=new V;for(const{tile:s,x:n,y:o}of tt(i,e))t.set(n,o,{type:s.type});return t},ne=function(i,e){const t=new V;for(const{tile:s,x:n,y:o}of tt(i,e))t.set(n,o,{name:s.name});return t},oe=function(i,e){const t=i.layers.reduce((n,o)=>n.concat(o.tiles),[]),s=ie(t,i.patterns);e.setCollisionGrid(s)},re=function(i,e,t){i.layers.forEach(s=>{const n=ne(s.tiles,i.patterns),o=Yt(e,n,t);e.comp.layers.push(o)})},ae=function(i,e,t){i.entities.forEach(({name:n,pos:[o,r]})=>{const c=t[n],l=c();l.pos.set(o,r),e.entities.add(l)});const s=te(e.entities);e.comp.layers.push(s)},ce=async function(i){return async function(t){const s=await q(`/data/levels/${t}.json`),n=await E(s.spritesheet),o=new Et;return oe(s,o),re(s,o,n),ae(s,o,i),o}},le=function(i){const e=document.querySelector("[data-action='left']"),t=document.querySelector("[data-action='right']"),s=document.querySelector("[data-action='jump']"),n=document.querySelector("[data-action='speed']"),o={left:{elem:e,fn:function(c){_(i,c)},handle:!1},right:{elem:t,fn:function(c){K(i,c)},handle:!1},jump:{elem:s,fn:function(c){X(i,c)},handle:!1},speed:{elem:n,fn:function(c){$(i,c)},handle:!1}};["pointerdown","pointerup","pointercancel","pointerout","pointerleave"].forEach(c=>{for(const l in o){const d=o[l];d.elem.addEventListener(c,function(){if(c==="pointerdown")return d.handle=!0,d.fn(!0);d.handle&&(d.fn(!1),d.handle=!1)})}})},de=function(i){return function(t,s){t.strokeStyle="red",i.forEach(n=>{t.beginPath(),t.rect(n.bounds.left-s.pos.x,n.bounds.top-s.pos.y,n.size.x,n.size.y),t.stroke()})}},ue=function(i){const e=[],t=i.tiles,s=t.tileSize,n=t.getByIndex;return t.getByIndex=function(r,c){return e.push({x:r,y:c}),n.call(t,r,c)},function(r,c){r.strokeStyle="blue",e.forEach(({x:l,y:d})=>{r.beginPath(),r.rect(l*s-c.pos.x,d*s-c.pos.y,s,s),r.stroke()}),e.length=0}};function he(i){if(!i.tileCollider)return;const e=ue(i.tileCollider),t=de(i.entities);return function(n,o){e(n,o),t(n,o)}}function fe(i){return[...i].includes(i)}class pe{constructor(e,t=m){a(this,"sprites");a(this,"size",m);this.sprites=e,this.size=t}print(e,t,s,n){[...e].forEach((o,r)=>{fe(o)&&this.sprites.draw(o,t,s+r*this.size,n)})}}const me=async function(){return Y(dt).then(i=>{const e=new J(i,m,m),t=i.width;for(const[s,n]of[...ut].entries()){const o=s*m%t,r=Math.floor(s*m/t)*m;e.define(n,o,r,m,m)}return new pe(e)})},ye=function(i,e){const t=i.size,s=i.size*2,n=16;return function(r){const{time:c,score:l}=e.playerController;i.print("MARIO",r,16,t),i.print(l.toString().padStart(6,"0"),r,16,s),i.print(`@x${n.toString().padStart(2,"0")}`,r,96,s),i.print("WORLD",r,152,t),i.print("1-1",r,160,s),i.print("TIME",r,208,t),i.print(c.toFixed().toString().padStart(3,"0"),r,216,s)}},we=async function(i){const e=i.getContext("2d"),t=new AudioContext,[s,n]=await Promise.all([Ut(t),me()]),r=await(await ce(s))("1-1"),c=new yt,l=Ot(s.mario()),d=Dt(l);r.entities.add(d);const h=he(r);h&&r.comp.layers.push(h),r.comp.layers.push(ye(n,d)),pt(l).listenTo(window),le(l);const y={audioContext:t,deltaTime:0},g=new mt;g.update=function(st){y.deltaTime=st,r.update(y),c.pos.x=Math.max(0,l.pos.x-100),r.comp.draw(e,c)},g.start()},A=document.getElementById("screen"),B=A.getContext("2d");B.font="30px Comic Sans MS";B.fillStyle="white";B.textAlign="center";B.fillText("Hit Click To Play",A.width/2,A.height/2);const et=function(){window.removeEventListener("click",et),we(A)};window.addEventListener("click",et);
