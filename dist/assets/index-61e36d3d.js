var A=Object.defineProperty;var b=(o,e,t)=>e in o?A(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var n=(o,e,t)=>(b(o,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class L{constructor(){n(this,"layers");this.layers=[]}draw(e,t){this.layers.forEach(i=>{i(e,t)})}}class O{constructor(){n(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((t,i)=>{t.forEach((s,r)=>{e(s,i,r)})})}get(e,t){const i=this.grid[e];if(i)return i[t]}set(e,t,i){this.grid[e]||(this.grid[e]=[]),this.grid[e][t]=i}}class p{constructor(e,t){n(this,"x");n(this,"y");this.set(e,t)}set(e,t){this.x=e,this.y=t}}const w=16,v={x:64,y:64},T={w:14,h:16},z=1500,P=1,_=0,x={SPACE:"Space",ARROW_RIGHT:"ArrowRight",ARROW_LEFT:"ArrowLeft",SPEED_X:"KeyX"},B=256+16,N=240,E=.001,C=2e-4,y={TOP:Symbol("top"),BOTTOM:Symbol("bottom")};class k{constructor(e,t=w){n(this,"matrix");n(this,"tileSize");this.matrix=e,this.tileSize=t}toIndex(e){return Math.floor(e/this.tileSize)}toIndexRange(e,t){const i=Math.ceil(t/this.tileSize)*this.tileSize,s=[];let r=e;do s.push(this.toIndex(r)),r+=this.tileSize;while(r<i);return s}getByIndex(e,t){const i=this.matrix.get(e,t);if(i){const s=e*this.tileSize,r=s+this.tileSize,a=t*this.tileSize,c=a+this.tileSize;return{tile:i,x1:s,x2:r,y1:a,y2:c}}}searchByPosition(e,t){return this.getByIndex(this.toIndex(e),this.toIndex(t))}searchByRange(e,t,i,s){const r=[];return this.toIndexRange(e,t).forEach(a=>{this.toIndexRange(i,s).forEach(c=>{const h=this.getByIndex(a,c);h&&r.push(h)})}),r}}class D{constructor(e){n(this,"tiles");this.tiles=new k(e)}checkX(e){let t;if(e.vel.x>0)t=e.pos.x+e.size.x;else if(e.vel.x<0)t=e.pos.x;else return;this.tiles.searchByRange(t,t,e.pos.y,e.pos.y+e.size.y).forEach(s=>{s.tile.type==="ground"&&(e.vel.x>0?e.pos.x+e.size.x>s.x1&&(e.pos.x=s.x1-e.size.x,e.vel.x=0):e.vel.x<0&&e.pos.x<s.x2&&(e.pos.x=s.x2,e.vel.x=0))})}checkY(e){let t;if(e.vel.y>0)t=e.pos.y+e.size.y;else if(e.vel.y<0)t=e.pos.y;else return;this.tiles.searchByRange(e.pos.x,e.pos.x+e.size.x,t,t).forEach(s=>{s.tile.type==="ground"&&(e.vel.y>0?e.pos.y+e.size.y>s.y1&&(e.pos.y=s.y1-e.size.y,e.vel.y=0,e.obstruct(y.BOTTOM)):e.vel.y<0&&e.pos.y<s.y2&&(e.pos.y=s.y2,e.vel.y=0,e.obstruct(y.TOP)))})}}class F{constructor(){n(this,"gravity");n(this,"comp");n(this,"entities");n(this,"tiles");n(this,"tileCollider");n(this,"totalTime");this.gravity=z,this.totalTime=0,this.comp=new L,this.entities=new Set,this.tiles=new O,this.tileCollider=new D(this.tiles)}update(e){this.entities.forEach(t=>{t.update(e),t.pos.x+=t.vel.x*e,this.tileCollider.checkX(t),t.pos.y+=t.vel.y*e,this.tileCollider.checkY(t),t.vel.y+=this.gravity*e}),this.totalTime+=e}}class q{constructor(e,t,i){n(this,"image");n(this,"width");n(this,"height");n(this,"tiles");n(this,"animation");this.image=e,this.width=t,this.height=i,this.tiles=new Map,this.animation=new Map}defineAnim(e,t){this.animation.set(e,t)}define(e,t,i,s,r){const a=[!1,!0].map(c=>{const h=document.createElement("canvas");h.width=s,h.height=r;const d=h.getContext("2d");return c&&(d.scale(-1,1),d.translate(-s,0)),d.drawImage(this.image,t,i,s,r,0,0,s,r),h});this.tiles.set(e,a)}defineTile(e,t,i){this.define(e,t*this.width,i*this.height,this.width,this.height)}draw(e,t,i,s,r=!1){const a=this.tiles.get(e);a&&t.drawImage(a[Number(r)],i,s)}drawAnim(e,t,i,s,r){const a=this.animation.get(e);this.drawTile(a(r),t,i,s)}drawTile(e,t,i,s){this.draw(e,t,i*this.width,s*this.height)}}class S{constructor(e){n(this,"NAME");this.NAME=e}obstruct(e,t){}update(e,t){console.warn("Unhandled update call in Trait")}}class j{constructor(){n(this,"pos");n(this,"vel");n(this,"size");n(this,"traits");n(this,"draw");n(this,"turbo");this.pos=new p(0,0),this.vel=new p(0,0),this.size=new p(0,0),this.traits=[]}addTrait(e){this.traits.push(e),this[e.NAME]=e}obstruct(e){this.traits.forEach(t=>{t.obstruct(this,e)})}update(e){this.traits.forEach(t=>{t.update(this,e)})}}class W{constructor(){n(this,"keyStates");n(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(e,t){this.keyMap.set(e,t)}handleEvent(e){const{code:t}=e;if(!this.keyMap.has(t))return;e.preventDefault();const i=e.type==="keydown"?P:_;this.keyStates.get(t)!==i&&(this.keyStates.set(t,i),this.keyMap.get(t)(i))}listenTo(e){["keydown","keyup"].forEach(i=>{e.addEventListener(i,s=>{this.handleEvent(s)})})}}class G extends S{constructor(){super("go");n(this,"dir");n(this,"acceleration");n(this,"deceleration");n(this,"dragFactor");n(this,"distance");n(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=E,this.distance=0,this.heading=1}update(t,i){const s=Math.abs(t.vel.x);if(this.dir!==0)t.vel.x+=this.acceleration*i*this.dir,t.jump?t.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(t.vel.x!==0){const a=Math.min(s,this.deceleration*i);t.vel.x+=t.vel.x>0?-a:a}else this.distance=0;const r=this.dragFactor*t.vel.x*s;t.vel.x-=r,this.distance+=s*i}}class H extends S{constructor(){super("jump");n(this,"duration");n(this,"velocity");n(this,"engageTime");n(this,"ready");n(this,"requestTime");n(this,"gracePeriod");n(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(t,i){i===y.BOTTOM?this.ready=1:i===y.TOP&&this.cancel()}update(t,i){this.requestTime>0&&(this.ready>0&&(this.engageTime=this.duration,this.requestTime=0),this.requestTime-=i),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),this.engageTime-=i),this.ready--}}const I=function(o,e){return function(i){const s=Math.floor(i/e)%o.length;return o[s]}},K=async function(){const o=await R("mario"),e=new j;e.size.set(T.w,T.h),e.addTrait(new G),e.go.dragFactor=E,e.addTrait(new H),e.turbo=function(a){this.go.dragFactor=a?C:E};const i=I(["run-1","run-2","run-3"],6);function s(r){return r.jump.falling?"jump":r.go.distance>0?r.vel.x>0&&r.go.dir<0||r.vel.x<0&&r.go.dir>0?"break":i(r.go.distance):"idle"}return e.draw=function(a){o.draw(s(this),a,0,0,this.go.heading<0)},e},X=function(o){const e=new W;return e.addMapping(x.SPACE,t=>{t?o.jump.start():o.jump.cancel()}),e.addMapping(x.SPEED_X,t=>{o.turbo(t)}),e.addMapping(x.ARROW_RIGHT,t=>{o.go.dir+=t?1:-1}),e.addMapping(x.ARROW_LEFT,t=>{o.go.dir+=t?-1:1}),e},Y=function(o,e){const t=o.tiles,i=o.tileCollider.tiles,s=document.createElement("canvas");s.width=B,s.height=N;const r=s.getContext("2d");let a,c;function h(d,u){a=d,c=u;for(let l=a;l<=c;++l){const g=t.grid[l];g&&g.forEach((f,m)=>{e.animation.has(f.name)?e.drawAnim(f.name,r,l-a,m,o.totalTime):e.drawTile(f.name,r,l-a,m)})}}return function(u,l){const g=i.toIndex(l.size.x),f=i.toIndex(l.pos.x),m=f+g;h(f,m),u.drawImage(s,-l.pos.x%w,-l.pos.y)}},J=function(o,e=64,t=64){const i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");return function(a,c){o.forEach(h=>{s.clearRect(0,0,e,t),h.draw(s),a.drawImage(i,h.pos.x-c.pos.x,h.pos.y-c.pos.y)})}},U=function(o){return new Promise(e=>{const t=new Image;t.addEventListener("load",()=>{e(t)}),t.src=o})},M=async function(o){return fetch(o).then(e=>e.json())},V=function(o,e){function t(i,s,r,a,c){const h=s+r,d=a+c;for(let u=s;u<h;++u)for(let l=a;l<d;++l)o.tiles.set(u,l,{name:i.tile,type:i.type})}e.forEach(i=>{i.ranges.forEach(s=>{if(s.length===4){const[r,a,c,h]=s;t(i,r,a,c,h)}else if(s.length===3){const[r,a,c]=s;t(i,r,a,c,1)}else if(s.length===2){const[r,a]=s;t(i,r,1,a,1)}})})},R=async function(o){var s,r,a;const e=await M(`/@sprites/${o}.json`),t=await U(e.imageURL),i=new q(t,e.tileW||w,e.tileH||w);return(s=e.tiles)==null||s.forEach(c=>{i.defineTile(c.name,c.index[0],c.index[1])}),(r=e.frames)==null||r.forEach(c=>{i.define(c.name,...c.rect)}),(a=e.animations)==null||a.forEach(c=>{const h=I(c.frames,c.frameLen);i.defineAnim(c.name,h)}),i},Z=async function(o){const e=await M(`/@levels/${o}.json`),t=await R(e.spritesheet),i=new F;V(i,e.backgrounds);const s=Y(i,t);i.comp.layers.push(s);const r=J(i.entities);return i.comp.layers.push(r),i};class ${constructor(e=1/60){n(this,"update");n(this,"updateProxy");let t=0,i=0;this.updateProxy=s=>{for(t+=(s-i)/1e3,t>1&&(t=1);t>e;)this.update(e),t-=e;i=s,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class Q{constructor(){n(this,"pos");n(this,"size");this.pos=new p(0,0),this.size=new p(256,224)}}const ee=document.getElementById("screen"),te=ee.getContext("2d");Promise.all([K(),Z("1-1")]).then(([o,e])=>{const t=new Q;o.pos.set(v.x,v.y),e.entities.add(o),X(o).listenTo(window);const s=new $;s.update=function(a){e.update(a),o.pos.x>100&&(t.pos.x=o.pos.x-100),e.comp.draw(te,t)},s.start()});
