var et=Object.defineProperty;var st=(s,t,e)=>t in s?et(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(st(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const M=16,m=8;var P=(s=>(s[s.x=64]="x",s[s.y=64]="y",s))(P||{}),R=(s=>(s[s.w=14]="w",s[s.h=16]="h",s))(R||{}),T=(s=>(s[s.w=16]="w",s[s.h=16]="h",s))(T||{}),O=(s=>(s[s.w=16]="w",s[s.h=14]="h",s))(O||{}),k=(s=>(s[s.x=100]="x",s[s.y=-200]="y",s))(k||{});const it=1500,nt=1,ot=0;var b=(s=>(s.SPACE="Space",s.ARROW_RIGHT="ArrowRight",s.ARROW_LEFT="ArrowLeft",s.SPEED_X="KeyX",s))(b||{});const H=256,N=256;var D=(s=>(s[s.width=64]="width",s[s.height=64]="height",s))(D||{});const W=.001,rt=2e-4,u={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")},at=100,ct="./assets/img/font-coin.png",lt=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",j=30;class dt{constructor(){a(this,"keyStates");a(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return;t.preventDefault();const i=t.type==="keydown"?nt:ot;this.keyStates.get(e)!==i&&(this.keyStates.set(e,i),this.keyMap.get(e)(i))}listenTo(t){["keydown","keyup"].forEach(i=>{t.addEventListener(i,n=>{this.handleEvent(n)})})}}const $=function(s,t){t?s.jump.start():s.jump.cancel()},X=function(s,t){s.turbo&&s.turbo(t)},K=function(s,t){s.go.dir+=t?1:-1},_=function(s,t){s.go.dir+=t?-1:1},ut=function(s,t){return function(i){const n=Math.floor(i/t)%s.length;return s[n]}},ht=function(s){const t=new dt;return t.addMapping(b.SPACE,e=>{$(s,e)}),t.addMapping(b.SPEED_X,e=>{X(s,e)}),t.addMapping(b.ARROW_RIGHT,e=>{K(s,e)}),t.addMapping(b.ARROW_LEFT,e=>{_(s,e)}),t};class ft{constructor(t=1/60){a(this,"update");a(this,"updateProxy");let e=0,i=0;this.updateProxy=n=>{for(e+=(n-i)/1e3,e>1&&(e=1);e>t;)this.update(t),e-=t;i=n,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class pt{constructor(){a(this,"grid");this.grid=[]}forEach(t){this.grid.forEach((e,i)=>{e.forEach((n,r)=>{t(n,i,r)})})}delete(t,e){const i=this.grid[t];i&&delete i[e]}get(t,e){const i=this.grid[t];if(i)return i[e]}set(t,e,i){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=i}}class w{constructor(t,e){a(this,"x");a(this,"y");this.set(t,e)}copy(t){this.x=t.x,this.y=t.y}set(t,e){this.x=t,this.y=e}}class mt{constructor(){a(this,"pos");a(this,"size");this.pos=new w(0,0),this.size=new w(H,N)}}class yt{constructor(){a(this,"layers");this.layers=[]}draw(t,e){this.layers.forEach(i=>{i(t,e)})}}class wt{constructor(t){a(this,"entities");this.entities=t}check(t){this.entities.forEach(e=>{t!==e&&t.bounds.overlaps(e.bounds)&&t.collides(e)})}}class gt{constructor(){a(this,"player");this.player=null}setPlayer(t){this.player=t}}class V{constructor(t,e=M){a(this,"matrix");a(this,"tileSize");this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const i=Math.ceil(e/this.tileSize)*this.tileSize,n=[];let r=t;do n.push(this.toIndex(r)),r+=this.tileSize;while(r<i);return n}getByIndex(t,e){const i=this.matrix.get(t,e);if(!i)return;const n=t*this.tileSize,r=n+this.tileSize,o=e*this.tileSize,c=o+this.tileSize;return{tile:i,indexX:t,indexY:e,x1:n,x2:r,y1:o,y2:c}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,i,n){const r=[];return this.toIndexRange(t,e).forEach(o=>{this.toIndexRange(i,n).forEach(c=>{const l=this.getByIndex(o,c);l&&r.push(l)})}),r}}function vt({entity:s,match:t}){s.vel.x>0?s.bounds.right>t.x1&&s.obstruct(u.RIGHT,t):s.vel.x<0&&s.bounds.left<t.x2&&s.obstruct(u.LEFT,t)}function bt({entity:s,match:t}){s.vel.y>0?s.bounds.bottom>t.y1&&s.obstruct(u.BOTTOM,t):s.vel.y<0&&s.bounds.top<t.y2&&s.obstruct(u.TOP,t)}const xt=[vt,bt];function Tt({entity:s,match:t}){s.vel.x>0?s.bounds.right>t.x1&&s.obstruct(u.RIGHT,t):s.vel.x<0&&s.bounds.left<t.x2&&s.obstruct(u.LEFT,t)}function kt({entity:s,match:t,resolver:e,gameContext:i,level:n}){if(s.vel.y>0)s.bounds.bottom>t.y1&&s.obstruct(u.BOTTOM,t);else if(s.vel.y<0){if(s.player){e.matrix.delete(t.indexX,t.indexY);const o=i.entityFactory.goomba();o.vel.set(50,-400),o.pos.set(s.pos.x,t.y1),n.entities.add(o)}s.bounds.top<t.y2&&s.obstruct(u.TOP,t)}}const Et=[Tt,kt],St={ground:xt,brick:Et};class At{constructor(){a(this,"resolvers");this.resolvers=[]}addGrid(t){this.resolvers.push(new V(t))}checkX(t,e,i){let n;if(t.vel.x>0)n=t.bounds.right;else if(t.vel.x<0)n=t.bounds.left;else return;for(const r of this.resolvers)r.searchByRange(n,n,t.bounds.top,t.bounds.bottom).forEach(c=>{this._handle(0,t,c,r,e,i)})}checkY(t,e,i){let n;if(t.vel.y>0)n=t.bounds.bottom;else if(t.vel.y<0)n=t.bounds.top;else return;for(const r of this.resolvers)r.searchByRange(t.bounds.left,t.bounds.right,n,n).forEach(c=>{this._handle(1,t,c,r,e,i)})}_handle(t,e,i,n,r,o){if(!i.tile.type)return;const c={entity:e,match:i,resolver:n,gameContext:r,level:o},l=St[i.tile.type][t];l&&l(c)}}class Mt{constructor(){a(this,"gravity");a(this,"comp");a(this,"entities");a(this,"tiles");a(this,"tileCollider");a(this,"entityCollider");a(this,"totalTime");a(this,"music");this.gravity=it,this.totalTime=0,this.music=new gt,this.comp=new yt,this.entities=new Set,this.entityCollider=new wt(this.entities),this.tileCollider=new At}update(t){this.entities.forEach(e=>{this.tileCollider&&e.update(t,this)}),this.entities.forEach(e=>{this.entityCollider.check(e)}),this.entities.forEach(e=>{e.finalize()}),this.totalTime+=t.deltaTime}}class Q{constructor(){a(this,"buffers");this.buffers=new Map}addAudio(t,e){this.buffers.set(t,e)}playAudio(t,e){const i=e.createBufferSource();i.connect(e.destination),i.buffer=this.buffers.get(t)||null,i.start(0)}}class Lt{constructor(t,e,i){a(this,"pos");a(this,"size");a(this,"offset");this.pos=t,this.size=e,this.offset=i}overlaps(t){return this.bottom>t.top&&this.top<t.bottom&&this.left<t.right&&this.right>t.left}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}class Ct{constructor(){a(this,"listeners");this.listeners=[]}listen(t,e){const i={name:t,callback:e};this.listeners.push(i)}emit(t,...e){this.listeners.forEach(i=>{i.name===t&&i.callback(...e)})}}class h{constructor(t){a(this,"NAME");a(this,"tasks");a(this,"events");this.NAME=t,this.tasks=[],this.events=new Ct}finalize(){this.tasks.forEach(t=>t()),this.tasks.length=0}queue(t){this.tasks.push(t)}collides(t,e){}obstruct(t,e,i=void 0){}update(t,e,i=void 0){}}class v{constructor(){a(this,"pos");a(this,"vel");a(this,"size");a(this,"offset");a(this,"bounds");a(this,"traits");a(this,"lifetime");a(this,"canCollide");a(this,"audio");a(this,"sounds");a(this,"turbo");this.canCollide=!0,this.pos=new w(0,0),this.vel=new w(0,0),this.size=new w(0,0),this.offset=new w(0,0),this.bounds=new Lt(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[],this.audio=new Q,this.sounds=new Set}addTrait(t){this.traits.push(t),this[t.NAME]=t}collides(t){this.traits.forEach(e=>{e.collides(this,t)})}obstruct(t,e=void 0){this.traits.forEach(i=>{i.obstruct(this,t,e)})}playSound(t,e){this.sounds.forEach(i=>{t.playAudio(i,e)}),this.sounds.clear()}update(t,e){this.traits.forEach(i=>{i.update(this,t,e)}),this.playSound(this.audio,t.audioContext),this.lifetime+=t.deltaTime}draw(t){}finalize(){this.traits.forEach(t=>{t.finalize()})}}class J{constructor(t,e,i){a(this,"image");a(this,"width");a(this,"height");a(this,"tiles");a(this,"animations");this.image=t,this.width=e,this.height=i,this.tiles=new Map,this.animations=new Map}defineAnim(t,e){this.animations.set(t,e)}define(t,e,i,n,r){const o=[!1,!0].map(c=>{const l=document.createElement("canvas");l.width=n,l.height=r;const d=l.getContext("2d");return c&&(d.scale(-1,1),d.translate(-n,0)),d.drawImage(this.image,e,i,n,r,0,0,n,r),l});this.tiles.set(t,o)}defineTile(t,e,i){this.define(t,e*this.width,i*this.height,this.width,this.height)}draw(t,e,i,n,r=!1){const o=this.tiles.get(t);o&&e.drawImage(o[Number(r)],i,n)}drawAnim(t,e,i,n,r){const o=this.animations.get(t);this.drawTile(o(r),e,i,n)}drawTile(t,e,i,n){this.draw(t,e,i*this.width,n*this.height)}}const E=async function(s){var n,r,o;const t=await F(`/data/sprites/${s}.json`),e=await Z(t.imageURL),i=new J(e,t.tileW||M,t.tileH||M);return(n=t.tiles)==null||n.forEach(c=>{i.defineTile(c.name,c.index[0],c.index[1])}),(r=t.frames)==null||r.forEach(c=>{i.define(c.name,...c.rect)}),(o=t.animations)==null||o.forEach(c=>{const l=ut(c.frames,c.frameLen);i.defineAnim(c.name,l)}),i};class C extends h{constructor(){super("killable");a(this,"dead");a(this,"deadTime");a(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>this.dead=!0)}revive(){this.dead=!1,this.deadTime=0}update(e,{deltaTime:i},n){this.dead&&(this.deadTime+=i,!(this.deadTime<=this.removeAfter)&&this.queue(()=>{n.entities.delete(e)}))}}class Ft extends h{constructor(){super("velocity")}update(t,{deltaTime:e}){t.pos.x+=t.vel.x*e,t.pos.y+=t.vel.y*e}}class zt extends h{constructor(){super("gravity")}update(t,{deltaTime:e},i){t.vel.y+=i.gravity*e}}const Bt=async function(s){return E("bullet").then(Rt)};let Pt=class extends h{constructor(){super("behavior");a(this,"gravity");this.gravity=new zt}collides(e,i){var n;if(!e.killable.dead&&i.stomper){if(i.vel.y<=e.vel.y){(n=i.killable)==null||n.kill();return}e.killable.kill(),e.vel.set(k.x,k.y)}}update(e,i,n){e.killable.dead&&this.gravity.update(e,i,n)}};const Rt=function(s){const t=function(e){s.draw("bullet",e,0,0,this.vel.x<0)};return function(){const i=new v;return i.size.set(O.w,O.h),i.addTrait(new Ft),i.addTrait(new Pt),i.addTrait(new C),i.draw=t,i}};async function I(s,t){const e=Ot(t),i=await F(`/data/sounds/${s}.json`),n=new Q,r=i.fx,o=[];return Object.keys(r).forEach(l=>{const{url:d}=r[l],p=e(d).then(f=>{n.addAudio(l,f)});o.push(p)}),Promise.all(o).then(()=>n)}function Ot(s){return async function(e){return fetch(e).then(i=>i.arrayBuffer()).then(i=>s.decodeAudioData(i))}}class Dt extends h{constructor(){super("emitter");a(this,"interval");a(this,"coolDown");a(this,"emitters");this.interval=4,this.coolDown=this.interval,this.emitters=[]}emit(e,i){for(const n of this.emitters)n(e,i)}update(e,{deltaTime:i},n){this.coolDown-=i,!(this.coolDown>0)&&(this.emit(e,n),this.coolDown=this.interval)}}class Gt extends h{constructor(){super("player");a(this,"lives");a(this,"score");this.lives=3,this.score=0}}class qt extends h{constructor(){super("playerController");a(this,"player");a(this,"checkpoint");a(this,"time");a(this,"score");this.checkpoint=new w(0,0),this.player=null,this.time=300,this.score=0}setPlayer(e){this.player=e,this.player.stomper&&this.player.stomper.events.listen("stomp",()=>{this.score+=at})}update(e,{deltaTime:i},n){var r;if(this.player){if(!n.entities.has(this.player)){(r=this.player.killable)==null||r.revive(),this.player.pos.set(this.checkpoint.x,this.checkpoint.y),n.entities.add(this.player);return}this.time-=i*2}}}const jt=function(s){const t=new v,e=new qt;return e.checkpoint.set(P.x,P.y),e.setPlayer(s),t.addTrait(e),t},Ht=function(s){return s.addTrait(new Gt),s},Nt=function*(s){for(const t of s.entities)t.player&&(yield t)},Wt=async function(s,t){const e=await I("cannon",s);return $t(e,t)},$t=function(s,t){const e=function(i,n){let r=1;for(const c of Nt(n)){if(c.pos.x>i.pos.x-j&&c.pos.x<i.pos.x+j)return;c.pos.x<i.pos.x&&(r=-1)}const o=t.bullet();o.pos.copy(i.pos),o.vel.set(80*r,0),i.sounds.add("shoot"),n.entities.add(o)};return function(){const n=new v;n.audio=s;const r=new Dt;return r.emitters.push(e),n.addTrait(r),n}};class Y extends h{constructor(){super("pendulumMove");a(this,"speed");a(this,"enabled");this.enabled=!0,this.speed=-30}obstruct(e,i){(i===u.LEFT||i===u.RIGHT)&&(this.speed=-this.speed)}update(e){this.enabled&&(e.vel.x=this.speed)}}class G extends h{constructor(){super("physics")}update(t,e,i){const{deltaTime:n}=e;t.pos.x+=t.vel.x*n,i.tileCollider.checkX(t,e,i),t.pos.y+=t.vel.y*n,i.tileCollider.checkY(t,e,i),t.vel.y+=i.gravity*n}}class q extends h{constructor(){super("solid");a(this,"obstructs");this.obstructs=!0}obstruct(e,i,n){this.obstructs&&(i===u.BOTTOM?(e.bounds.bottom=n.y1,e.vel.y=0):i===u.TOP?(e.bounds.top=n.y2,e.vel.y=0):i===u.LEFT?(e.bounds.left=n.x2,e.vel.x=0):i===u.RIGHT&&(e.bounds.right=n.x1,e.vel.x=0))}}const Xt=async function(s){return E("goomba").then(_t)};let Kt=class extends h{constructor(){super("behavior")}collides(t,e){var i;if(!t.killable.dead&&e.stomper){if(e.vel.y<=t.vel.y){(i=e.killable)==null||i.kill();return}t.killable.kill(),t.pendulumMove.speed=0}}};const _t=function(s){const t=s.animations.get("walk"),e=function(n){return n.killable.dead?"flat":t(n.lifetime)},i=function(n){s.draw(e(this),n,0,0)};return function(){const r=new v;return r.size.set(T.w,T.h),r.addTrait(new G),r.addTrait(new q),r.addTrait(new Y),r.addTrait(new Kt),r.addTrait(new C),r.draw=i,r}},Vt=async function(s){return E("koopa").then(Jt)},S=Symbol("walking"),x=Symbol("hiding"),A=Symbol("panic");class Qt extends h{constructor(){super("behavior");a(this,"state");a(this,"hideTime");a(this,"hideDuration");a(this,"panicSpeed");a(this,"walkSpeed");this.hideTime=0,this.hideDuration=5,this.panicSpeed=300,this.walkSpeed=null,this.state=S}collides(e,i){if(!e.killable.dead&&i.stomper){if(i.vel.y<=e.vel.y){this.handleNudge(e,i);return}this.handleStomp(e,i)}}handleNudge(e,i){var n,r;if(this.state===S)(n=i.killable)==null||n.kill();else if(this.state===x)this.panic(e,i);else if(this.state===A){const o=Math.sign(e.vel.x),c=Math.sign(e.pos.x-i.pos.x);o!==0&&o!==c&&((r=i.killable)==null||r.kill())}}handleStomp(e,i){this.state===S?this.hide(e):this.state===x?(e.killable.kill(),e.vel.set(k.x,k.y),e.solid.obstructs=!1):this.state===A&&this.hide(e)}hide(e){e.vel.x=0,e.pendulumMove.enabled=!1,this.walkSpeed===null&&(this.walkSpeed=e.pendulumMove.speed),this.hideTime=0,this.state=x}unhide(e){e.pendulumMove.enabled=!0,this.walkSpeed&&(e.pendulumMove.speed=this.walkSpeed),this.state=S}panic(e,i){e.pendulumMove.enabled=!0,e.pendulumMove.speed=this.panicSpeed*Math.sign(i.vel.x),this.state=A}update(e,{deltaTime:i}){this.state===x&&(this.hideTime+=i,!(this.hideTime<=this.hideDuration)&&this.unhide(e))}}const Jt=function(s){const t=s.animations.get("walk"),e=s.animations.get("wake"),i=function(r){const o=r.behavior;return o.state===x?o.hideTime>3?e(o.hideTime):"hiding":o.state===A?"hiding":t(r.lifetime)},n=function(r){s.draw(i(this),r,0,0,this.vel.x<0)};return function(){const o=new v;return o.size.set(T.w,T.h),o.offset.y=8,o.addTrait(new G),o.addTrait(new q),o.addTrait(new Y),o.addTrait(new Qt),o.addTrait(new C),o.draw=n,o}};class It extends h{constructor(){super("go");a(this,"dir");a(this,"acceleration");a(this,"deceleration");a(this,"dragFactor");a(this,"distance");a(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=W,this.distance=0,this.heading=1}update(e,{deltaTime:i}){const n=Math.abs(e.vel.x);if(this.dir!==0)e.vel.x+=this.acceleration*i*this.dir,e.jump?e.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(e.vel.x!==0){const o=Math.min(n,this.deceleration*i);e.vel.x+=e.vel.x>0?-o:o}else this.distance=0;const r=this.dragFactor*e.vel.x*n;e.vel.x-=r,this.distance+=n*i}}class Yt extends h{constructor(){super("jump");a(this,"duration");a(this,"velocity");a(this,"engageTime");a(this,"ready");a(this,"requestTime");a(this,"gracePeriod");a(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(e,i){i===u.BOTTOM?this.ready=1:i===u.TOP&&this.cancel()}update(e,{deltaTime:i}){this.requestTime>0&&(this.ready>0&&(e.sounds.add("jump"),this.engageTime=this.duration,this.requestTime=0),this.requestTime-=i),this.engageTime>0&&(e.vel.y=-(this.velocity+Math.abs(e.vel.x)*this.speedBoost),this.engageTime-=i),this.ready--}}class Zt extends h{constructor(){super("stomper");a(this,"bounceSpeed");this.bounceSpeed=400}bounce(e,i){e.bounds.bottom=i.bounds.top,e.vel.y=-this.bounceSpeed}collides(e,i){!i.killable||i.killable.dead||e.vel.y>i.vel.y&&(this.queue(()=>this.bounce(e,i)),e.sounds.add("stomp"),this.events.emit("stomp",e,i))}}const Ut=async function(s){const t=await E("mario"),e=await I("mario",s);return te(t,e)},te=function(s,t){const e=s.animations.get("run");function i(o){return o.jump.falling?"jump":o.go.distance>0?o.vel.x>0&&o.go.dir<0||o.vel.x<0&&o.go.dir>0?"break":e(o.go.distance):"idle"}function n(o){this.go.dragFactor=o?rt:W}function r(o){s.draw(i(this),o,0,0,this.go.heading<0)}return function(){const c=new v;return c.audio=t,c.size.set(R.w,R.h),c.addTrait(new G),c.addTrait(new q),c.addTrait(new It),c.addTrait(new Yt),c.addTrait(new Zt),c.addTrait(new C),c.killable.removeAfter=0,c.turbo=n,c.draw=r,c.turbo(!1),c}},Z=function(s){return new Promise(t=>{const e=new Image;e.addEventListener("load",()=>{t(e)}),e.src=s})},F=async function(s){return fetch(s).then(t=>t.json())},ee=async function(s){const t={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")},bullet:function(){throw new Error("Function not implemented.")},cannon:function(){throw new Error("Function not implemented.")}},e=function(i){return n=>t[i]=n};return Promise.all([Ut(s).then(e("mario")),Xt().then(e("goomba")),Vt().then(e("koopa")),Bt().then(e("bullet")),Wt(s,t).then(e("cannon"))]).then(()=>t)},se=function(s,t,e){const i=new V(t),n=document.createElement("canvas");n.width=H+16,n.height=N;const r=n.getContext("2d");function o(c,l){r.clearRect(0,0,n.width,n.height);for(let d=c;d<=l;++d){const p=t.grid[d];p&&p.forEach((f,y)=>{const g=f;e.animations.has(g.name)?e.drawAnim(g.name,r,d-c,y,s.totalTime):e.drawTile(g.name,r,d-c,y)})}}return function(l,d){const p=i.toIndex(d.size.x),f=i.toIndex(d.pos.x),y=f+p;o(f,y),l.drawImage(n,-d.pos.x%M,-d.pos.y)}},ie=function(s,t=D.width,e=D.width){const i=document.createElement("canvas");i.width=t,i.height=e;const n=i.getContext("2d");return function(o,c){s.forEach(l=>{n.clearRect(0,0,t,e),l.draw(n),o.drawImage(i,l.pos.x-c.pos.x,l.pos.y-c.pos.y)})}};class ne{constructor(){a(this,"tracks");this.tracks=new Map}addTrack(t,e){const i=new Audio;i.loop=!0,i.src=e,this.tracks.set(t,i)}playTrack(t){const e=this.tracks.get(t);e==null||e.play()}}async function oe(s){const t=await F(`/data/music/${s}.json`),e=new ne;for(const[i,n]of Object.entries(t))e.addTrack(i,n.url);return e}const B=function*(s,t,e,i){const n=s+t,r=e+i;for(let o=s;o<n;++o)for(let c=e;c<r;++c)yield{x:o,y:c}},re=function(s){if(s.length===4){const[t,e,i,n]=s;return B(t,e,i,n)}else if(s.length===3){const[t,e,i]=s;return B(t,e,i,1)}else{const[t,e]=s;return B(t,1,e,1)}},ae=function*(s){for(const t of s)yield*re(t)},ce=function*(s,t){function*e(i,n,r){for(const o of i)for(const{x:c,y:l}of ae(o.ranges)){const d=c+n,p=l+r;if(o.pattern){const f=t[o.pattern];yield*e(f.tiles,d,p);continue}yield{tile:o,x:d,y:p}}}yield*e(s,0,0)},le=function(s,t){const e=new pt;for(const{tile:i,x:n,y:r}of ce(s,t))e.set(n,r,i);return e},de=function(s,t,e){s.layers.forEach(i=>{const n=le(i.tiles,s.patterns),r=se(t,n,e);t.comp.layers.push(r),t.tileCollider.addGrid(n)})},ue=function(s,t,e){s.entities.forEach(({name:n,pos:[r,o]})=>{const c=e[n],l=c();l.pos.set(r,o),t.entities.add(l)});const i=ie(t.entities);t.comp.layers.push(i)},he=async function(s){return async function(e){const i=await F(`/data/levels/${e}.json`),n=await E(i.spriteSheet),r=await oe(i.musicSheet),o=new Mt;return o.music.setPlayer(r),de(i,o,n),ue(i,o,s),o}},fe=function(s){const t=document.querySelector("[data-action='left']"),e=document.querySelector("[data-action='right']"),i=document.querySelector("[data-action='jump']"),n=document.querySelector("[data-action='speed']"),r={left:{elem:t,fn:function(c){_(s,c)},handle:!1},right:{elem:e,fn:function(c){K(s,c)},handle:!1},jump:{elem:i,fn:function(c){$(s,c)},handle:!1},speed:{elem:n,fn:function(c){X(s,c)},handle:!1}};["pointerdown","pointerup","pointercancel","pointerout","pointerleave"].forEach(c=>{for(const l in r){const d=r[l];d.elem.addEventListener(c,function(){if(c==="pointerdown")return d.handle=!0,d.fn(!0);d.handle&&(d.fn(!1),d.handle=!1)})}})};function pe(s){return[...s].includes(s)}class me{constructor(t,e=m){a(this,"sprites");a(this,"size",m);this.sprites=t,this.size=e}print(t,e,i,n){[...t].forEach((r,o)=>{pe(r)&&this.sprites.draw(r,e,i+o*this.size,n)})}}const ye=async function(){return Z(ct).then(s=>{const t=new J(s,m,m),e=s.width;for(const[i,n]of[...lt].entries()){const r=i*m%e,o=Math.floor(i*m/e)*m;t.define(n,r,o,m,m)}return new me(t)})},we=function(s,t){const e=s.size,i=s.size*2,n=16;return function(o){const{time:c,score:l}=t.playerController;s.print("MARIO",o,16,e),s.print(l.toString().padStart(6,"0"),o,16,i),s.print(`@x${n.toString().padStart(2,"0")}`,o,96,i),s.print("WORLD",o,152,e),s.print("1-1",o,160,i),s.print("TIME",o,208,e),s.print(c.toFixed().toString().padStart(3,"0"),o,216,i)}},ge=async function(s){var g;const t=s.getContext("2d"),e=new AudioContext,[i,n]=await Promise.all([ee(e),ye()]),o=await(await he(i))("1-1"),c=new mt,l=Ht(i.mario()),d=jt(l);o.entities.add(d),o.comp.layers.push(we(n,d)),ht(l).listenTo(window),fe(l);const f={audioContext:e,entityFactory:i,deltaTime:0},y=new ft;y.update=function(tt){f.deltaTime=tt,o.update(f),c.pos.x=Math.max(0,l.pos.x-100),o.comp.draw(t,c)},y.start(),(g=o.music.player)==null||g.playTrack("main")},L=document.getElementById("screen"),z=L.getContext("2d");z.font="30px Comic Sans MS";z.fillStyle="white";z.textAlign="center";z.fillText("Hit Click To Play",L.width/2,L.height/2);const U=function(){window.removeEventListener("click",U),ge(L)};window.addEventListener("click",U);
