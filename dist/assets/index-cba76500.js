var I=Object.defineProperty;var S=(r,e,s)=>e in r?I(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var n=(r,e,s)=>(S(r,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}})();class v{constructor(){n(this,"layers");this.layers=[]}draw(e){this.layers.forEach(s=>{s(e)})}}class T{constructor(){n(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((s,t)=>{s.forEach((i,o)=>{e(i,t,o)})})}get(e,s){const t=this.grid[e];if(t)return t[s]}set(e,s,t){this.grid[e]||(this.grid[e]=[]),this.grid[e][s]=t}}class d{constructor(e,s){n(this,"x");n(this,"y");this.set(e,s)}set(e,s){this.x=e,this.y=s}}const h=16,p={sky:{x:3,y:23},ground:{x:0,y:0},mario:{x:276,y:44}},f={x:64,y:64},g={w:14,h:16},R=2e3,k=!0,z=!1,u={SPACE:"Space",ARROW_RIGHT:"ArrowRight",ARROW_LEFT:"ArrowLeft"},L=640,M=256;class A{constructor(e,s=h){n(this,"matrix");n(this,"tileSize");this.matrix=e,this.tileSize=s}_toIndex(e){return~~(e/this.tileSize)}toIndexRange(e,s){const t=~(s/this.tileSize)*this.tileSize,i=[];let o=e;do i.push(this._toIndex(o)),o+=this.tileSize;while(o<t);return i}getByIndex(e,s){const t=this.matrix.get(e,s);if(t){const i=e*this.tileSize,o=i+this.tileSize,a=s*this.tileSize,c=a+this.tileSize;return{tile:t,x1:i,x2:o,y1:a,y2:c}}}searchByPosition(e,s){return this.getByIndex(this._toIndex(e),this._toIndex(s))}searchByRange(e,s,t,i){const o=[];return this.toIndexRange(e,s).forEach(a=>{this.toIndexRange(t,i).forEach(c=>{const l=this.getByIndex(a,c);l&&o.push(l)})}),o}}class _{constructor(e){n(this,"tiles");this.tiles=new A(e)}checkX(e){let s;if(e.vel.x>0)s=e.pos.x+e.size.x;else if(e.vel.x<0)s=e.pos.x;else return;this.tiles.searchByRange(s,s,e.pos.y,e.pos.y+e.size.y).forEach(i=>{i.tile.name==="ground"&&(e.vel.x>0?e.pos.x+e.size.x>i.x1&&(e.pos.x=i.x1-e.size.x,e.vel.x=0):e.vel.x<0&&e.pos.x<i.x2&&(e.pos.x=i.x2,e.vel.x=0))})}checkY(e){let s;if(e.vel.y>0)s=e.pos.y+e.size.y;else if(e.vel.y<0)s=e.pos.y;else return;this.tiles.searchByRange(e.pos.x,e.pos.x+e.size.x,s,s).forEach(i=>{i.tile.name==="ground"&&(e.vel.y>0?e.pos.y+e.size.y>i.y1&&(e.pos.y=i.y1-e.size.y,e.vel.y=0):e.vel.y<0&&e.pos.y<i.y2&&(e.pos.y=i.y2,e.vel.y=0))})}test(e){this.checkY(e)}}class P{constructor(){n(this,"comp");n(this,"entities");n(this,"tiles");n(this,"tileCollider");this.comp=new v,this.entities=new Set,this.tiles=new T,this.tileCollider=new _(this.tiles)}update(e){this.entities.forEach(s=>{s.update(e),s.pos.x+=s.vel.x*e,this.tileCollider.checkX(s),s.pos.y+=s.vel.y*e,this.tileCollider.checkY(s),s.vel.y+=R*e})}}class y{constructor(e){n(this,"NAME");this.NAME=e}update(e,s){console.warn("Unhandled update call in Trait")}}class B{constructor(){n(this,"pos");n(this,"vel");n(this,"size");n(this,"traits");n(this,"draw");this.pos=new d(0,0),this.vel=new d(0,0),this.size=new d(0,0),this.traits=[]}addTrait(e){this.traits.push(e),this[e.NAME]=e}update(e){this.traits.forEach(s=>{s.update(this,e)})}}class C{constructor(){n(this,"keyStates");n(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(e,s){this.keyMap.set(e,s)}handleEvent(e){const{code:s}=e;if(!this.keyMap.has(s))return;e.preventDefault();const t=e.type==="keydown"?k:z;this.keyStates.get(s)!==t&&(this.keyStates.set(s,t),this.keyMap.get(s)(t))}listenTo(e){["keydown","keyup"].forEach(t=>{e.addEventListener(t,i=>{this.handleEvent(i)})})}}class m{constructor(e,s,t){n(this,"image");n(this,"width");n(this,"height");n(this,"tiles");this.image=e,this.width=s,this.height=t,this.tiles=new Map}define(e,s,t,i,o){var c;const a=document.createElement("canvas");a.width=i,a.height=o,(c=a.getContext("2d"))==null||c.drawImage(this.image,s,t,i,o,0,0,i,o),this.tiles.set(e,a)}defineTile(e,s,t){this.define(e,s*this.width,t*this.height,this.width,this.height)}draw(e,s,t,i){const o=this.tiles.get(e);s.drawImage(o,t,i)}drawTile(e,s,t,i){this.draw(e,s,t*this.width,i*this.height)}}const O="/assets/tiles-1dcaf0e0.png",b="/assets/characters-802da64a.gif",w={tiles:O,characters:b},N=async function(){const r=await x(w.characters),e=new m(r,h,h),s=p.mario;return e.define("idle",s.x,s.y,16,16),e},D=async function(){const r=await x(w.tiles),e=new m(r,h,h),s=p.ground;e.defineTile("ground",s.x,s.y);const t=p.sky;return e.defineTile("sky",t.x,t.y),e};class G extends y{constructor(){super("go");n(this,"dir");n(this,"speed");this.dir=0,this.speed=6e3}update(s,t){s.vel.x=this.speed*this.dir*t}}class Y extends y{constructor(){super("jump");n(this,"duration");n(this,"velocity");n(this,"engageTime");this.duration=.5,this.engageTime=0,this.velocity=200}start(){this.engageTime=this.duration}cancel(){this.engageTime=0}update(s,t){this.engageTime>0&&(s.vel.y=-this.velocity,this.engageTime-=t)}}const j=async function(){const r=await N(),e=new B;return e.size.set(g.w,g.h),e.addTrait(new G),e.addTrait(new Y),e.draw=function(t){r.draw("idle",t,this.pos.x,this.pos.y)},e},q=async function(r){return fetch(`/@levels/${r}.json`).then(e=>e.json())},F=function(r){const e=new C;return e.addMapping(u.SPACE,s=>{s?r.jump.start():r.jump.cancel()}),e.addMapping(u.ARROW_RIGHT,s=>{r.go.dir=+s}),e.addMapping(u.ARROW_LEFT,s=>{r.go.dir=-s}),e},H=function(r,e){const s=document.createElement("canvas");s.width=L,s.height=M;const t=s.getContext("2d");return r.tiles.forEach((i,o,a)=>{e.drawTile(i.name,t,o,a)}),function(o){o.drawImage(s,0,0)}},K=function(r){return function(s){r.forEach(t=>{t.draw(s)})}};function W(r){const e=[],s=r.tileCollider.tiles,t=s.tileSize,i=s.getByIndex;return s.getByIndex=function(a,c){return e.push({x:a,y:c}),i.call(s,a,c)},function(a){a.strokeStyle="blue",e.forEach(({x:c,y:l})=>{a.beginPath(),a.rect(c*t,l*t,t,t),a.stroke()}),a.strokeStyle="red",r.entities.forEach(c=>{a.beginPath(),a.rect(c.pos.x,c.pos.y,c.size.x,c.size.y),a.stroke()}),e.length=0}}const x=function(r){return new Promise(e=>{const s=new Image;s.addEventListener("load",()=>{e(s)}),s.src=r})},V=function(r,e){e.forEach(s=>{s.ranges.forEach(([t,i,o,a])=>{for(let c=t;c<i;++c)for(let l=o;l<a;++l)r.tiles.set(c,l,{name:s.tile})})})},X=async function(r){return Promise.all([q(r),D()]).then(([e,s])=>{const t=new P;V(t,e.backgrounds);const i=H(t,s);t.comp.layers.push(i);const o=K(t.entities);return t.comp.layers.push(o),t})};class Z{constructor(e=1/60){n(this,"update");n(this,"updateProxy");let s=0,t=0;this.updateProxy=i=>{for(s+=(i-t)/1e3;s>e;)this.update(e),s-=e;t=i,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}const E=document.getElementById("screen"),J=E.getContext("2d");Promise.all([j(),X("1-1")]).then(([r,e])=>{r.pos.set(f.x,f.y),e.comp.layers.push(W(e)),e.entities.add(r),F(r).listenTo(window),["mousedown","mousemove"].forEach(i=>{E.addEventListener(i,o=>{o.buttons===1&&(r.vel.set(0,0),r.pos.set(o.offsetX,o.offsetY))})});const t=new Z;t.update=function(o){e.update(o),e.comp.draw(J)},t.start()});
