var W=Object.defineProperty;var O=(s,t,e)=>t in s?W(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>(O(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();const x=16;var E=(s=>(s[s.x=64]="x",s[s.y=64]="y",s))(E||{}),S=(s=>(s[s.w=14]="w",s[s.h=16]="h",s))(S||{}),w=(s=>(s[s.w=16]="w",s[s.h=16]="h",s))(w||{});const D=1500,X=1,J=0;var g=(s=>(s.SPACE="Space",s.ARROW_RIGHT="ArrowRight",s.ARROW_LEFT="ArrowLeft",s.SPEED_X="KeyX",s))(g||{});const z=256,M=256;var T=(s=>(s[s.width=64]="width",s[s.height=64]="height",s))(T||{});const F=.001,K=2e-4,h={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),RIGHT:Symbol("right"),LEFT:Symbol("left")};class U{constructor(){r(this,"keyStates");r(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(t,e){this.keyMap.set(t,e)}handleEvent(t){const{code:e}=t;if(!this.keyMap.has(e))return;t.preventDefault();const o=t.type==="keydown"?X:J;this.keyStates.get(e)!==o&&(this.keyStates.set(e,o),this.keyMap.get(e)(o))}listenTo(t){["keydown","keyup"].forEach(o=>{t.addEventListener(o,n=>{this.handleEvent(n)})})}}const G=function(s,t){t?s.jump.start():s.jump.cancel()},R=function(s,t){s.turbo&&s.turbo(t)},B=function(s,t){s.go.dir+=t?1:-1},P=function(s,t){s.go.dir+=t?-1:1},V=function(s,t){return function(o){const n=Math.floor(o/t)%s.length;return s[n]}},$=function(s){const t=new U;return t.addMapping(g.SPACE,e=>{G(s,e)}),t.addMapping(g.SPEED_X,e=>{R(s,e)}),t.addMapping(g.ARROW_RIGHT,e=>{B(s,e)}),t.addMapping(g.ARROW_LEFT,e=>{P(s,e)}),t};class Q{constructor(t=1/60){r(this,"update");r(this,"updateProxy");let e=0,o=0;this.updateProxy=n=>{for(e+=(n-o)/1e3,e>1&&(e=1);e>t;)this.update(t),e-=t;o=n,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class A{constructor(){r(this,"grid");this.grid=[]}forEach(t){this.grid.forEach((e,o)=>{e.forEach((n,i)=>{t(n,o,i)})})}get(t,e){const o=this.grid[t];if(o)return o[e]}set(t,e,o){this.grid[t]||(this.grid[t]=[]),this.grid[t][e]=o}}class m{constructor(t,e){r(this,"x");r(this,"y");this.set(t,e)}set(t,e){this.x=t,this.y=e}}class N{constructor(){r(this,"pos");r(this,"size");this.pos=new m(0,0),this.size=new m(z,M)}}class Z{constructor(){r(this,"layers");this.layers=[]}draw(t,e){this.layers.forEach(o=>{o(t,e)})}}class q{constructor(t,e=x){r(this,"matrix");r(this,"tileSize");this.matrix=t,this.tileSize=e}toIndex(t){return Math.floor(t/this.tileSize)}toIndexRange(t,e){const o=Math.ceil(e/this.tileSize)*this.tileSize,n=[];let i=t;do n.push(this.toIndex(i)),i+=this.tileSize;while(i<o);return n}getByIndex(t,e){const o=this.matrix.get(t,e);if(o){const n=t*this.tileSize,i=n+this.tileSize,c=e*this.tileSize,a=c+this.tileSize;return{tile:o,x1:n,x2:i,y1:c,y2:a}}}searchByPosition(t,e){return this.getByIndex(this.toIndex(t),this.toIndex(e))}searchByRange(t,e,o,n){const i=[];return this.toIndexRange(t,e).forEach(c=>{this.toIndexRange(o,n).forEach(a=>{const u=this.getByIndex(c,a);u&&i.push(u)})}),i}}class Y{constructor(t){r(this,"tiles");this.tiles=new q(t)}checkX(t){let e;if(t.vel.x>0)e=t.bounds.right;else if(t.vel.x<0)e=t.bounds.left;else return;this.tiles.searchByRange(e,e,t.bounds.top,t.bounds.bottom).forEach(n=>{n.tile.type==="ground"&&(t.vel.x>0?t.bounds.right>n.x1&&(t.bounds.right=n.x1,t.vel.x=0,t.obstruct(h.RIGHT)):t.vel.x<0&&t.bounds.left<n.x2&&(t.bounds.left=n.x2,t.vel.x=0,t.obstruct(h.RIGHT)))})}checkY(t){let e;if(t.vel.y>0)e=t.bounds.bottom;else if(t.vel.y<0)e=t.bounds.top;else return;this.tiles.searchByRange(t.bounds.left,t.bounds.right,e,e).forEach(n=>{n.tile.type==="ground"&&(t.vel.y>0?t.bounds.bottom>n.y1&&(t.bounds.bottom=n.y1,t.vel.y=0,t.obstruct(h.BOTTOM)):t.vel.y<0&&t.bounds.top<n.y2&&(t.bounds.top=n.y2,t.vel.y=0,t.obstruct(h.TOP)))})}}class I{constructor(){r(this,"gravity");r(this,"comp");r(this,"entities");r(this,"tiles");r(this,"tileCollider");r(this,"totalTime");this.gravity=D,this.totalTime=0,this.comp=new Z,this.entities=new Set,this.tileCollider=null}setCollisionGrid(t){this.tileCollider=new Y(t)}update(t){this.entities.forEach(e=>{this.tileCollider&&(e.update(t),e.pos.x+=e.vel.x*t,this.tileCollider.checkX(e),e.pos.y+=e.vel.y*t,this.tileCollider.checkY(e),e.vel.y+=this.gravity*t)}),this.totalTime+=t}}const _=function(s,t,e){const o=new q(t),n=document.createElement("canvas");n.width=z,n.height=M;const i=n.getContext("2d");function c(a,u){i.clearRect(0,0,n.width,n.height);for(let d=a;d<=u;++d){const l=t.grid[d];l&&l.forEach((f,p)=>{const b=f;e.animations.has(b.name)?e.drawAnim(b.name,i,d-a,p,s.totalTime):e.drawTile(b.name,i,d-a,p)})}}return function(u,d){const l=o.toIndex(d.size.x),f=o.toIndex(d.pos.x),p=f+l;c(f,p),u.drawImage(n,-d.pos.x%x,-d.pos.y)}},tt=function(s,t=T.width,e=T.width){const o=document.createElement("canvas");o.width=t,o.height=e;const n=o.getContext("2d");return function(c,a){s.forEach(u=>{n.clearRect(0,0,t,e),u.draw(n),c.drawImage(o,u.pos.x-a.pos.x,u.pos.y-a.pos.y)})}};class et{constructor(t,e,o){r(this,"image");r(this,"width");r(this,"height");r(this,"tiles");r(this,"animations");this.image=t,this.width=e,this.height=o,this.tiles=new Map,this.animations=new Map}defineAnim(t,e){this.animations.set(t,e)}define(t,e,o,n,i){const c=[!1,!0].map(a=>{const u=document.createElement("canvas");u.width=n,u.height=i;const d=u.getContext("2d");return a&&(d.scale(-1,1),d.translate(-n,0)),d.drawImage(this.image,e,o,n,i,0,0,n,i),u});this.tiles.set(t,c)}defineTile(t,e,o){this.define(t,e*this.width,o*this.height,this.width,this.height)}draw(t,e,o,n,i=!1){const c=this.tiles.get(t);c&&e.drawImage(c[Number(i)],o,n)}drawAnim(t,e,o,n,i){const c=this.animations.get(t);this.drawTile(c(i),e,o,n)}drawTile(t,e,o,n){this.draw(t,e,o*this.width,n*this.height)}}class st{constructor(t,e,o){r(this,"pos");r(this,"size");r(this,"offset");this.pos=t,this.size=e,this.offset=o}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(t){this.pos.y=t-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(t){this.pos.y=t-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(t){this.pos.x=t-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(t){this.pos.x=t-(this.size.x+this.offset.x)}}class k{constructor(t){r(this,"NAME");this.NAME=t}obstruct(t,e){}update(t,e){console.warn("Unhandled update call in Trait")}}class L{constructor(){r(this,"pos");r(this,"vel");r(this,"size");r(this,"offset");r(this,"bounds");r(this,"traits");r(this,"lifetime");r(this,"draw");r(this,"turbo");this.pos=new m(0,0),this.vel=new m(0,0),this.size=new m(0,0),this.offset=new m(0,0),this.bounds=new st(this.pos,this.size,this.offset),this.lifetime=0,this.traits=[]}addTrait(t){this.traits.push(t),this[t.NAME]=t}obstruct(t){this.traits.forEach(e=>{e.obstruct(this,t)})}update(t){this.traits.forEach(e=>{e.update(this,t)}),this.lifetime+=t}}class C extends k{constructor(){super("pendulumWalk");r(this,"speed");this.speed=-30}obstruct(e,o){(o===h.LEFT||o===h.RIGHT)&&(this.speed=-this.speed)}update(e,o){e.vel.x=this.speed}}const ot=async function(){return y("goomba").then(nt)},nt=function(s){const t=s.animations.get("walk"),e=function(o){s.draw(t(this.lifetime),o,0,0)};return function(){const n=new L;return n.size.set(w.w,w.h),n.addTrait(new C),n.draw=e,n}},it=async function(){return y("koopa").then(rt)},rt=function(s){const t=s.animations.get("walk"),e=function(o){s.draw(t(this.lifetime),o,0,0,this.vel.x<0)};return function(){const n=new L;return n.size.set(w.w,w.h),n.offset.y=8,n.addTrait(new C),n.draw=e,n}};class at extends k{constructor(){super("go");r(this,"dir");r(this,"acceleration");r(this,"deceleration");r(this,"dragFactor");r(this,"distance");r(this,"heading");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=F,this.distance=0,this.heading=1}update(e,o){const n=Math.abs(e.vel.x);if(this.dir!==0)e.vel.x+=this.acceleration*o*this.dir,e.jump?e.jump.falling===!1&&(this.heading=this.dir):this.heading=this.dir;else if(e.vel.x!==0){const c=Math.min(n,this.deceleration*o);e.vel.x+=e.vel.x>0?-c:c}else this.distance=0;const i=this.dragFactor*e.vel.x*n;e.vel.x-=i,this.distance+=n*o}}class ct extends k{constructor(){super("jump");r(this,"duration");r(this,"velocity");r(this,"engageTime");r(this,"ready");r(this,"requestTime");r(this,"gracePeriod");r(this,"speedBoost");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod}cancel(){this.engageTime=0,this.requestTime=0}obstruct(e,o){o===h.BOTTOM?this.ready=1:o===h.TOP&&this.cancel()}update(e,o){this.requestTime>0&&(this.ready>0&&(this.engageTime=this.duration,this.requestTime=0),this.requestTime-=o),this.engageTime>0&&(e.vel.y=-(this.velocity+Math.abs(e.vel.x)*this.speedBoost),this.engageTime-=o),this.ready--}}const dt=async function(){return y("mario").then(ut)},ut=function(s){const t=s.animations.get("run");function e(i){return i.jump.falling?"jump":i.go.distance>0?i.vel.x>0&&i.go.dir<0||i.vel.x<0&&i.go.dir>0?"break":t(i.go.distance):"idle"}function o(i){this.go.dragFactor=i?K:F}function n(i){s.draw(e(this),i,0,0,this.go.heading<0)}return function(){const c=new L;return c.size.set(S.w,S.h),c.addTrait(new at),c.addTrait(new ct),c.turbo=o,c.draw=n,c.turbo(!1),c}},ht=function(s){return new Promise(t=>{const e=new Image;e.addEventListener("load",()=>{t(e)}),e.src=s})},j=async function(s){return fetch(s).then(t=>t.json())},y=async function(s){var n,i,c;const t=await j(`/@sprites/${s}.json`),e=await ht(t.imageURL),o=new et(e,t.tileW||x,t.tileH||x);return(n=t.tiles)==null||n.forEach(a=>{o.defineTile(a.name,a.index[0],a.index[1])}),(i=t.frames)==null||i.forEach(a=>{o.define(a.name,...a.rect)}),(c=t.animations)==null||c.forEach(a=>{const u=V(a.frames,a.frameLen);o.defineAnim(a.name,u)}),o},lt=function(){const s={mario:function(){throw new Error("Function not implemented.")},goomba:function(){throw new Error("Function not implemented.")},koopa:function(){throw new Error("Function not implemented.")}},t=function(e){return o=>s[e]=o};return Promise.all([dt().then(t("mario")),ot().then(t("goomba")),it().then(t("koopa"))]).then(()=>s)},v=function*(s,t,e,o){const n=s+t,i=e+o;for(let c=s;c<n;++c)for(let a=e;a<i;++a)yield{x:c,y:a}},ft=function(s){if(s.length===4){const[t,e,o,n]=s;return v(t,e,o,n)}else if(s.length===3){const[t,e,o]=s;return v(t,e,o,1)}else{const[t,e]=s;return v(t,1,e,1)}},pt=function*(s){for(const t of s)for(const e of ft(t))yield e},H=function(s,t){const e=[];function o(n,i,c){for(const a of n)for(const{x:u,y:d}of pt(a.ranges)){const l=u+i,f=d+c;if(a.pattern){const p=t[a.pattern];o(p.tiles,l,f);continue}e.push({tile:a,x:l,y:f})}}return o(s,0,0),e},mt=function(s,t){const e=new A;for(const{tile:o,x:n,y:i}of H(s,t))e.set(n,i,{type:o.type});return e},gt=function(s,t){const e=new A;for(const{tile:o,x:n,y:i}of H(s,t))e.set(n,i,{name:o.name});return e},wt=async function(s){const t=await j(`/@levels/${s}.json`),e=await y(t.spritesheet),o=new I,n=t.layers.reduce((a,u)=>a.concat(u.tiles),[]),i=mt(n,t.patterns);o.setCollisionGrid(i),t.layers.forEach(a=>{const u=gt(a.tiles,t.patterns),d=_(o,u,e);o.comp.layers.push(d)});const c=tt(o.entities);return o.comp.layers.push(c),o},xt=function(s){const t=document.querySelector("[data-action='left']"),e=document.querySelector("[data-action='right']"),o=document.querySelector("[data-action='jump']"),n=document.querySelector("[data-action='speed']"),i={left:{elem:t,fn:function(a){P(s,a)},handle:!1},right:{elem:e,fn:function(a){B(s,a)},handle:!1},jump:{elem:o,fn:function(a){G(s,a)},handle:!1},speed:{elem:n,fn:function(a){R(s,a)},handle:!1}};["mousedown","mouseup","mouseleave"].forEach(a=>{for(const u in i){const d=i[u];d.elem.addEventListener(a,function(){if(a==="mousedown")return d.handle=!0,d.fn(!0);d.handle&&(d.fn(!1),d.handle=!1)})}})},yt=document.getElementById("screen"),bt=yt.getContext("2d");Promise.all([lt(),wt("1-1")]).then(([s,t])=>{const e=new N,o=s.mario();o.pos.set(E.x,E.y),t.entities.add(o);const n=s.goomba();n.pos.set(220,16),t.entities.add(n);const i=s.koopa();i.pos.x=150,t.entities.add(i),$(o).listenTo(window),xt(o);const a=new Q;a.update=function(d){t.update(d),o.pos.x>100&&(e.pos.x=o.pos.x-100),t.comp.draw(bt,e)},a.start()});
