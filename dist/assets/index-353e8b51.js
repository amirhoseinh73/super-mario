var L=Object.defineProperty;var T=(o,e,t)=>e in o?L(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var c=(o,e,t)=>(T(o,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class M{constructor(){c(this,"layers");this.layers=[]}draw(e,t){this.layers.forEach(i=>{i(e,t)})}}class k{constructor(){c(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((t,i)=>{t.forEach((s,n)=>{e(s,i,n)})})}get(e,t){const i=this.grid[e];if(i)return i[t]}set(e,t,i){this.grid[e]||(this.grid[e]=[]),this.grid[e][t]=i}}class p{constructor(e,t){c(this,"x");c(this,"y");this.set(e,t)}set(e,t){this.x=e,this.y=t}}const x=16,C={mario:{x:276,y:44}},E={x:64,y:64},m={w:14,h:16},A=2e3,B=!0,P=!1,w={SPACE:"Space",ARROW_RIGHT:"ArrowRight",ARROW_LEFT:"ArrowLeft"},O=256+16,b=256;class _{constructor(e,t=x){c(this,"matrix");c(this,"tileSize");this.matrix=e,this.tileSize=t}toIndex(e){return~~(e/this.tileSize)}toIndexRange(e,t){const i=~(t/this.tileSize)*this.tileSize,s=[];let n=e;do s.push(this.toIndex(n)),n+=this.tileSize;while(n<i);return s}getByIndex(e,t){const i=this.matrix.get(e,t);if(i){const s=e*this.tileSize,n=s+this.tileSize,r=t*this.tileSize,a=r+this.tileSize;return{tile:i,x1:s,x2:n,y1:r,y2:a}}}searchByPosition(e,t){return this.getByIndex(this.toIndex(e),this.toIndex(t))}searchByRange(e,t,i,s){const n=[];return this.toIndexRange(e,t).forEach(r=>{this.toIndexRange(i,s).forEach(a=>{const l=this.getByIndex(r,a);l&&n.push(l)})}),n}}class N{constructor(e){c(this,"tiles");this.tiles=new _(e)}checkX(e){let t;if(e.vel.x>0)t=e.pos.x+e.size.x;else if(e.vel.x<0)t=e.pos.x;else return;this.tiles.searchByRange(t,t,e.pos.y,e.pos.y+e.size.y).forEach(s=>{s.tile.type==="ground"&&(e.vel.x>0?e.pos.x+e.size.x>s.x1&&(e.pos.x=s.x1-e.size.x,e.vel.x=0):e.vel.x<0&&e.pos.x<s.x2&&(e.pos.x=s.x2,e.vel.x=0))})}checkY(e){let t;if(e.vel.y>0)t=e.pos.y+e.size.y;else if(e.vel.y<0)t=e.pos.y;else return;this.tiles.searchByRange(e.pos.x,e.pos.x+e.size.x,t,t).forEach(s=>{s.tile.type==="ground"&&(e.vel.y>0?e.pos.y+e.size.y>s.y1&&(e.pos.y=s.y1-e.size.y,e.vel.y=0):e.vel.y<0&&e.pos.y<s.y2&&(e.pos.y=s.y2,e.vel.y=0))})}test(e){this.checkY(e)}}class D{constructor(){c(this,"comp");c(this,"entities");c(this,"tiles");c(this,"tileCollider");this.comp=new M,this.entities=new Set,this.tiles=new k,this.tileCollider=new N(this.tiles)}update(e){this.entities.forEach(t=>{t.update(e),t.pos.x+=t.vel.x*e,this.tileCollider.checkX(t),t.pos.y+=t.vel.y*e,this.tileCollider.checkY(t),t.vel.y+=A*e})}}class S{constructor(e,t,i){c(this,"image");c(this,"width");c(this,"height");c(this,"tiles");this.image=e,this.width=t,this.height=i,this.tiles=new Map}define(e,t,i,s,n){var a;const r=document.createElement("canvas");r.width=s,r.height=n,(a=r.getContext("2d"))==null||a.drawImage(this.image,t,i,s,n,0,0,s,n),this.tiles.set(e,r)}defineTile(e,t,i){this.define(e,t*this.width,i*this.height,this.width,this.height)}draw(e,t,i,s){const n=this.tiles.get(e);t.drawImage(n,i,s)}drawTile(e,t,i,s){this.draw(e,t,i*this.width,s*this.height)}}class I{constructor(e){c(this,"NAME");this.NAME=e}update(e,t){console.warn("Unhandled update call in Trait")}}class W{constructor(){c(this,"pos");c(this,"vel");c(this,"size");c(this,"traits");c(this,"draw");this.pos=new p(0,0),this.vel=new p(0,0),this.size=new p(0,0),this.traits=[]}addTrait(e){this.traits.push(e),this[e.NAME]=e}update(e){this.traits.forEach(t=>{t.update(this,e)})}}class j{constructor(){c(this,"keyStates");c(this,"keyMap");this.keyStates=new Map,this.keyMap=new Map}addMapping(e,t){this.keyMap.set(e,t)}handleEvent(e){const{code:t}=e;if(!this.keyMap.has(t))return;e.preventDefault();const i=e.type==="keydown"?B:P;this.keyStates.get(t)!==i&&(this.keyStates.set(t,i),this.keyMap.get(t)(i))}listenTo(e){["keydown","keyup"].forEach(i=>{e.addEventListener(i,s=>{this.handleEvent(s)})})}}const G="/assets/characters-802da64a.gif",H={characters:G},Y=async function(){const o=await R(H.characters),e=new S(o,x,x),t=C.mario;return e.define("idle",t.x,t.y,16,16),e};class q extends I{constructor(){super("go");c(this,"dir");c(this,"speed");this.dir=0,this.speed=6e3}update(t,i){t.vel.x=this.speed*this.dir*i}}class F extends I{constructor(){super("jump");c(this,"duration");c(this,"velocity");c(this,"engageTime");this.duration=.5,this.engageTime=0,this.velocity=200}start(){this.engageTime=this.duration}cancel(){this.engageTime=0}update(t,i){this.engageTime>0&&(t.vel.y=-this.velocity,this.engageTime-=i)}}const K=async function(){const o=await Y(),e=new W;return e.size.set(m.w,m.h),e.addTrait(new q),e.addTrait(new F),e.draw=function(i){o.draw("idle",i,0,0)},e},v=async function(o){return fetch(o).then(e=>e.json())},X=function(o){const e=new j;return e.addMapping(w.SPACE,t=>{t?o.jump.start():o.jump.cancel()}),e.addMapping(w.ARROW_RIGHT,t=>{o.go.dir=+t}),e.addMapping(w.ARROW_LEFT,t=>{o.go.dir=-t}),e};function J(o,e,t){const i=["mousedown","mousemove"];let s;i.forEach(n=>{o.addEventListener(n,r=>{r.buttons===1?(e.vel.set(0,0),e.pos.set(r.offsetX+t.pos.x,r.offsetY+t.pos.y)):r.buttons===2&&s&&s.buttons===2&&s.type==="mousemove"&&(t.pos.x-=r.offsetX-s.offsetX),s=r})}),o.addEventListener("contextmenu",n=>n.preventDefault())}const U=function(o,e){const t=o.tiles,i=o.tileCollider.tiles,s=document.createElement("canvas");s.width=O,s.height=b;const n=s.getContext("2d");let r,a;function l(u,h){if(!(u===r&&h===a)){r=u,a=h,console.log("redrawing");for(let d=r;d<=a;++d){const f=t.grid[d];f&&f.forEach((g,y)=>{e.drawTile(g.name,n,d-r,y)})}}}return function(h,d){const f=i.toIndex(d.size.x),g=i.toIndex(d.pos.x),y=g+f;l(g,y),h.drawImage(s,-d.pos.x%x,-d.pos.y)}},V=function(o,e=64,t=64){const i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");return function(r,a){o.forEach(l=>{s.clearRect(0,0,e,t),l.draw(s),r.drawImage(i,l.pos.x-a.pos.x,l.pos.y-a.pos.y)})}};function Z(o){const e=[],t=o.tileCollider.tiles,i=t.tileSize,s=t.getByIndex;return t.getByIndex=function(r,a){return e.push({x:r,y:a}),s.call(t,r,a)},function(r,a){r.strokeStyle="blue",e.forEach(({x:l,y:u})=>{r.beginPath(),r.rect(l*i-a.pos.x,u*i-a.pos.y,i,i),r.stroke()}),r.strokeStyle="red",o.entities.forEach(l=>{r.beginPath(),r.rect(l.pos.x-a.pos.x,l.pos.y-a.pos.y,l.size.x,l.size.y),r.stroke()}),e.length=0}}const $=function(o){return function(t,i){t.strokeStyle="purple",t.beginPath(),t.rect(o.pos.x-i.pos.x,o.pos.y-i.pos.y,o.size.x,o.size.y),t.stroke()}},R=function(o){return new Promise(e=>{const t=new Image;t.addEventListener("load",()=>{e(t)}),t.src=o})},Q=function(o,e){function t(i,s,n,r,a){const l=s+n,u=r+a;for(let h=s;h<l;++h)for(let d=r;d<u;++d)o.tiles.set(h,d,{name:i.tile,type:i.type})}e.forEach(i=>{i.ranges.forEach(s=>{if(s.length===4){const[n,r,a,l]=s;t(i,n,r,a,l)}else if(s.length===3){const[n,r,a]=s;t(i,n,r,a,1)}else if(s.length===2){const[n,r]=s;t(i,n,1,r,1)}})})},ee=async function(o){const e=await v(`/@sprites/${o}.json`),t=await R(e.imageURL),i=new S(t,e.tileW,e.tileH);return e.tiles.forEach(s=>{i.defineTile(s.name,s.index[0],s.index[1])}),i},te=async function(o){const e=await v(`/@levels/${o}.json`),t=await ee(e.spritesheet),i=new D;Q(i,e.backgrounds);const s=U(i,t);i.comp.layers.push(s);const n=V(i.entities);return i.comp.layers.push(n),i};class se{constructor(e=1/60){c(this,"update");c(this,"updateProxy");let t=0,i=0;this.updateProxy=s=>{for(t+=(s-i)/1e3;t>e;)this.update(e),t-=e;i=s,this.enqueue()}}enqueue(){requestAnimationFrame(this.updateProxy)}start(){this.enqueue()}}class ie{constructor(){c(this,"pos");c(this,"size");this.pos=new p(0,0),this.size=new p(256,256)}}const z=document.getElementById("screen"),oe=z.getContext("2d");Promise.all([K(),te("1-1")]).then(([o,e])=>{const t=new ie;o.pos.set(E.x,E.y),e.comp.layers.push(Z(e),$(t)),e.entities.add(o),X(o).listenTo(window),J(z,o,t);const s=new se;s.update=function(r){e.update(r),e.comp.draw(oe,t)},s.start()});
